# TTS 批量转换工具

一个基于 Flask 的 Markdown 文件批量转 MP3 工具，支持智能文本清理和多种微软语音选择。

## 功能特性

### ✨ 智能文本处理

- 发送完整的 MD 文件内容给 TTS API
- API 端自动移除 Markdown 语法标记（**粗体**、_斜体_、`代码`等）
- API 端自动移除表情符号 😊🎉
- API 端自动移除 URL 链接
- API 端自动合并为单行文本，优化语音播放效果

### 📁 批量处理功能

- **自定义目录名称**：支持手工输入目录名称（不加时间戳），或使用自动生成的随机目录名
- 将原始 MD 文件和生成的 MP3 文件放在同一目录下
- **状态图标显示**：使用 ✅/❌ 显示处理结果，🔄 显示处理中状态
- **实时进度反馈**：显示文件处理的各个阶段（读取、发送、等待、保存）
- **顺序处理**：避免 API 并发，确保稳定性和完整性
- **完整文本处理**：发送整个 MD 文件内容给 TTS API，由 API 端进行智能清理

### 🔗 多 API 服务器管理

- **多服务器支持**：可以添加多个 TTS API 服务器
- **负载均衡**：支持手动选择活动服务器
- **并发控制**：支持 1-5 个并发线程处理
- **动态管理**：支持添加、删除、启用/禁用服务器
- **自定义配置**：支持自定义服务器地址和 API 密钥

### 🎛️ 语音选择

支持多种微软中文语音：

- 晓晓 (温柔女声)
- 云扬 (专业男声)
- 云健 (激情男声)
- 晓伊 (活泼女声)
- 云溪 (阳光男声)
- 晓北 (东北女声)
- 云枫 (成熟男声)
- 晓辰 (清新女声)
- 云皓 (稳重男声)
- 晓涵 (知性女声)

### ⚡ 语速调节

- 支持 0.5x 到 2.0x 语速调节
- 实时预览语速设置

## 安装和运行

1. 确保已安装 Python 3.7+
2. 安装依赖：

   ```bash
   pip install flask requests
   ```

3. 启动 TTS 服务（需要先运行 demo.js 中的服务）

4. 运行 Flask 应用：

   ```bash
   python app.py
   ```

5. 在浏览器中访问 `http://localhost:5000`

## 使用方法

1. 选择要转换的 Markdown 文件（支持多选）
2. **配置 TTS API 服务器**：
   - 点击"+ 添加服务器"添加新的 API 服务器
   - 输入服务器名称、地址（如：http://8.138.98.126:5050）和 API 密钥
   - 选择要使用的服务器
   - 设置并发数（1-5）
3. **输入自定义目录名称**（可选，留空则自动生成）
4. 选择喜欢的语音音色
5. 调节语速（可选）
6. 点击"开始转换"
7. 等待转换完成，MP3 文件将保存在对应的批量目录中

## 文件结构

```
tts_批量转化/
├── app.py              # Flask 主应用
├── demo.js             # TTS 服务（需要单独运行）
├── templates/
│   └── index.html      # Web 界面
├── uploads/            # 上传文件临时目录
│   └── batch_*/        # 批量处理目录（自动生成）
├── mp3/               # 生成的 MP3 文件目录
│   └── batch_*/        # 批量处理目录（自动生成）
└── README.md          # 说明文档
```

## 批量处理说明

每次批量上传时，系统会：

1. **目录命名**：
   - 如果输入了自定义目录名称：`自定义名称`（不加时间戳）
   - 如果留空：`batch_时间戳_随机ID`
2. 在 `uploads/` 目录下创建对应的子目录
3. 将原始 MD 文件和生成的 MP3 文件都保存在 `uploads/目录名/` 目录中
4. **顺序处理**：逐个处理文件，避免 API 并发调用
5. 实时显示每个文件的处理状态（⏳ 等待、🔄 处理中、✅ 完成、❌ 失败）
6. 显示当前正在处理的文件序号
7. **实时进度反馈**：显示文件处理的各个阶段
8. 显示批量处理的统计信息（成功/失败文件数量）

### 进度反馈说明

系统会实时显示文件处理的各个阶段：

- **📖 读取文件...** - 读取 Markdown 文件内容
- **📤 准备发送到 TTS API...** - 准备发送请求
- **⏳ 等待 TTS 处理中...** - 等待 TTS API 处理（主要等待时间）
- **💾 保存音频文件...** - 保存返回的 MP3 文件
- **✅ 转换完成** - 处理完成

### 自定义目录名称规则

- 支持中文、英文、数字、下划线
- 不能包含特殊字符：`< > : " / \ | ? *` 等
- 最大长度：50 个字符
- 留空则使用自动生成的随机目录名

### 文件结构

```
uploads/
├── qlzd/                    # 自定义目录名称
│   ├── 第920-929章.md
│   ├── 第920-929章.mp3
│   ├── 第930-939章.md
│   ├── 第930-939章.mp3
│   └── ...
└── batch_1757768863_a1b2c3d4/  # 自动生成目录
    ├── 文件1.md
    ├── 文件1.mp3
    └── ...
```

### 处理流程

1. **文件上传**：所有文件先保存到批量目录
2. **状态初始化**：所有文件状态设为"等待处理"
3. **顺序处理**：逐个读取完整文件内容并发送给 TTS API
4. **进度更新**：实时更新每个文件的处理状态和进度
5. **完成统计**：显示最终处理结果

## 注意事项

- 确保 TTS 服务（demo.js）正在运行在端口 5050
- 支持的文件格式：.md
- 转换后的文件会覆盖同名文件
- 建议单个文件不要过大，以确保转换稳定性
