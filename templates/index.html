<!DOCTYPE html>
<html>
  <head>
    <title>TTSè½¬æ¢å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
      .progress-bar {
        transition: width 0.3s ease;
      }

      /* æ¨¡æ€æ¡†æ ·å¼ */
      .modal-backdrop {
        backdrop-filter: blur(2px);
      }

      .modal-content {
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .batch-badge {
        background-color: #eff6ff;
        color: #1e40af;
      }
      /* è‡ªå®šä¹‰æ»‘å—æ ·å¼ */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
        cursor: pointer;
      }
      input[type="range"]::-webkit-slider-track {
        background: #e5e7eb;
        height: 8px;
        border-radius: 4px;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        background: #3b82f6;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        cursor: pointer;
      }
      input[type="range"]::-moz-range-track {
        background: #e5e7eb;
        height: 8px;
        border-radius: 4px;
        border: none;
      }
      input[type="range"]::-moz-range-thumb {
        background: #3b82f6;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        cursor: pointer;
        border: none;
      }
      /* é€‰æ‹©æ¡†æ ·å¼ */
      select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
      }

      /* æŠ˜å å±•å¼€åŠ¨ç”»æ ·å¼ */
      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        opacity: 0;
      }

      .collapsible-content.expanded {
        max-height: 1000px;
        opacity: 1;
        transition: max-height 0.3s ease-in, opacity 0.3s ease-in;
      }

      .collapsible-arrow {
        transition: transform 0.3s ease;
      }

      .collapsible-arrow.rotated {
        transform: rotate(180deg);
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-2xl font-bold text-blue-600 mb-4">Markdownæ‰¹é‡è½¬MP3</h1>

      <!-- ä¸Šä¼ åŒºåŸŸ -->
      <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <input
          type="file"
          id="file-input"
          multiple
          accept=".md"
          class="hidden"
        />
        <div class="text-center">
          <button
            id="select-files"
            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-lg font-medium"
          >
            ğŸ“ é€‰æ‹©Markdownæ–‡ä»¶
          </button>
          <p class="text-sm text-gray-500 mt-2">æ”¯æŒå¤šé€‰ï¼Œè‡ªåŠ¨å¤„ç†æ–‡æœ¬æ ¼å¼</p>
        </div>

        <div class="mt-4">
          <label class="block mb-2 font-medium">ğŸ“ è‡ªå®šä¹‰ç›®å½•åç§°</label>
          <input
            type="text"
            id="custom-directory"
            placeholder="è¾“å…¥ç›®å½•åç§°ï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰"
            class="w-full p-2 border rounded"
          />
          <p class="text-xs text-gray-500 mt-1">
            æ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦
          </p>
        </div>

        <div class="mt-4">
          <label class="block mb-2 font-medium">ğŸ›ï¸ é€‰æ‹©éŸ³è‰²</label>
          <select id="voice-model" class="w-full p-2 border rounded">
            <option value="zh-CN-XiaoxiaoNeural">æ™“æ™“ (æ¸©æŸ”å¥³å£°)</option>
            <option value="zh-CN-YunyangNeural">äº‘æ‰¬ (ä¸“ä¸šç”·å£°)</option>
            <option value="zh-CN-YunjianNeural">äº‘å¥ (æ¿€æƒ…ç”·å£°)</option>
            <option value="zh-CN-XiaoyiNeural">æ™“ä¼Š (æ´»æ³¼å¥³å£°)</option>
            <option value="zh-CN-YunxiNeural">äº‘æºª (é˜³å…‰ç”·å£°)</option>
            <option value="zh-CN-liaoning-XiaobeiNeural">
              æ™“åŒ— (ä¸œåŒ—å¥³å£°)
            </option>
            <option value="zh-CN-YunfengNeural">äº‘æ« (æˆç†Ÿç”·å£°)</option>
            <option value="zh-CN-XiaochenNeural">æ™“è¾° (æ¸…æ–°å¥³å£°)</option>
            <option value="zh-CN-YunhaoNeural">äº‘çš“ (ç¨³é‡ç”·å£°)</option>
            <option value="zh-CN-XiaohanNeural">æ™“æ¶µ (çŸ¥æ€§å¥³å£°)</option>
          </select>
        </div>

        <!-- æœåŠ¡å™¨çŠ¶æ€ç›‘æ§ - ç§»åˆ°ä¸Šé¢ -->
        <div class="mt-4">
          <label class="block mb-2 font-medium">ğŸ–¥ï¸ æœåŠ¡å™¨çŠ¶æ€ç›‘æ§</label>
          <div
            id="server-monitor"
            class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 p-3 bg-gray-50 border rounded"
          >
            <div class="text-gray-500 text-sm">ç­‰å¾…æœåŠ¡å™¨çŠ¶æ€æ›´æ–°...</div>
          </div>
        </div>

        <div class="mt-4">
          <label class="block mb-2 font-medium">ğŸ”— TTS API æœåŠ¡å™¨ç®¡ç†</label>
          <div class="border rounded bg-gray-50">
            <!-- æŠ˜å å¤´éƒ¨ -->
            <div class="p-3">
              <div
                class="flex justify-between items-center cursor-pointer hover:bg-gray-100 transition-colors rounded p-2 -m-2"
                id="api-servers-header"
              >
                <div class="flex items-center space-x-2">
                  <span class="text-sm font-medium">API æœåŠ¡å™¨åˆ—è¡¨</span>
                  <span
                    id="api-servers-count"
                    class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded"
                    >0 ä¸ªæœåŠ¡å™¨</span
                  >
                </div>
                <div class="flex items-center space-x-2">
                  <span id="api-servers-status" class="text-xs text-gray-500"
                    >ç‚¹å‡»å±•å¼€</span
                  >
                  <svg
                    id="api-servers-arrow"
                    class="w-4 h-4 text-gray-500 collapsible-arrow"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    ></path>
                  </svg>
                </div>
              </div>

              <!-- å¹¶å‘æ§åˆ¶ - å§‹ç»ˆå¯è§ -->
              <div class="mt-3">
                <label class="block text-sm font-medium mb-1"
                  >âš¡ å¹¶å‘æ§åˆ¶</label
                >
                <div class="flex items-center space-x-4">
                  <input
                    type="range"
                    id="concurrency-slider"
                    min="1"
                    max="5"
                    value="1"
                    class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                  <span
                    id="concurrency-value"
                    class="text-sm font-medium text-gray-600 min-w-[2rem]"
                    >1</span
                  >
                  <span class="text-xs text-gray-500">å¹¶å‘æ•°</span>
                </div>
              </div>

              <!-- å¯¼å‡º/å¯¼å…¥æ§åˆ¶ -->
              <div class="mt-3">
                <label class="block text-sm font-medium mb-2"
                  >ğŸ“ é…ç½®ç®¡ç†</label
                >
                <div class="flex items-center space-x-2">
                  <button
                    id="export-config"
                    class="px-3 py-1.5 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors"
                  >
                    ğŸ“¤ å¯¼å‡ºé…ç½®
                  </button>
                  <button
                    id="import-config"
                    class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
                  >
                    ğŸ“¥ å¯¼å…¥é…ç½®
                  </button>
                  <input
                    type="file"
                    id="config-file-input"
                    accept=".json"
                    class="hidden"
                  />
                </div>
                <p class="text-xs text-gray-500 mt-1">
                  å¯¼å‡ºå½“å‰æœåŠ¡å™¨é…ç½®ä¸ºJSONæ–‡ä»¶ï¼Œæˆ–ä»JSONæ–‡ä»¶å¯¼å…¥é…ç½®
                </p>
              </div>
            </div>

            <!-- æŠ˜å å†…å®¹ -->
            <div id="api-servers-content" class="collapsible-content border-t">
              <div class="p-3">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-medium">æœåŠ¡å™¨é…ç½®</span>
                  <button
                    type="button"
                    id="add-api-btn"
                    class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600"
                  >
                    + æ·»åŠ æœåŠ¡å™¨
                  </button>
                </div>
                <div
                  id="api-servers-list"
                  class="space-y-2 max-h-96 overflow-y-auto"
                >
                  <!-- API æœåŠ¡å™¨åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <label class="block mb-2 font-medium">âš¡ è¯­é€Ÿè°ƒèŠ‚</label>
          <div class="flex items-center space-x-4">
            <input
              type="range"
              id="speed-slider"
              min="0.5"
              max="2.0"
              step="0.1"
              value="1.0"
              class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <span
              id="speed-value"
              class="text-sm font-medium text-gray-600 min-w-[3rem]"
              >1.0x</span
            >
          </div>
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>0.5x</span>
            <span>1.0x</span>
            <span>2.0x</span>
          </div>
        </div>

        <button
          id="start-convert"
          class="mt-4 w-full py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
          disabled
        >
          å¼€å§‹è½¬æ¢
        </button>
      </div>

      <!-- è¿›åº¦æ˜¾ç¤º -->
      <div
        id="progress-section"
        class="hidden bg-white p-6 rounded-lg shadow-md"
      >
        <h2 class="text-xl font-semibold mb-4">è½¬æ¢è¿›åº¦</h2>
        <div id="progress-container"></div>
      </div>
    </div>

    <script>
      // API æœåŠ¡å™¨ç®¡ç†
      let apiServers = [];
      let currentServerIndex = 0;

      // ä¿å­˜APIæœåŠ¡å™¨é…ç½®åˆ°localStorage
      function saveApiServersToStorage() {
        try {
          localStorage.setItem("tts_api_servers", JSON.stringify(apiServers));
          localStorage.setItem(
            "tts_current_server_index",
            currentServerIndex.toString()
          );
        } catch (error) {
          console.error("ä¿å­˜APIæœåŠ¡å™¨é…ç½®å¤±è´¥:", error);
        }
      }

      // ä»localStorageåŠ è½½APIæœåŠ¡å™¨é…ç½®
      function loadApiServersFromStorage() {
        try {
          const savedServers = localStorage.getItem("tts_api_servers");
          const savedIndex = localStorage.getItem("tts_current_server_index");

          if (savedServers) {
            apiServers = JSON.parse(savedServers);
            currentServerIndex = savedIndex ? parseInt(savedIndex) : 0;

            // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
            if (currentServerIndex >= apiServers.length) {
              currentServerIndex = 0;
            }
          } else {
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
            apiServers = [
              {
                id: "default",
                name: "é»˜è®¤æœåŠ¡å™¨",
                url: "https://mytts.pages.dev",
                apiKey: "123321",
                enabled: true,
              },
            ];
            currentServerIndex = 0;
            saveApiServersToStorage(); // ä¿å­˜é»˜è®¤é…ç½®
          }
        } catch (error) {
          console.error("åŠ è½½APIæœåŠ¡å™¨é…ç½®å¤±è´¥:", error);
          // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤é…ç½®
          apiServers = [
            {
              id: "default",
              name: "é»˜è®¤æœåŠ¡å™¨",
              url: "https://mytts.pages.dev",
              apiKey: "123321",
              enabled: true,
            },
          ];
          currentServerIndex = 0;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // é¦–å…ˆåŠ è½½ä¿å­˜çš„é…ç½®
        loadApiServersFromStorage();
        const fileInput = document.getElementById("file-input");
        const selectBtn = document.getElementById("select-files");
        const convertBtn = document.getElementById("start-convert");
        const progressSection = document.getElementById("progress-section");
        const progressContainer = document.getElementById("progress-container");
        const speedSlider = document.getElementById("speed-slider");
        const speedValue = document.getElementById("speed-value");
        const customDirectory = document.getElementById("custom-directory");
        const addApiBtn = document.getElementById("add-api-btn");
        const apiServersList = document.getElementById("api-servers-list");
        const concurrencySlider = document.getElementById("concurrency-slider");
        const concurrencyValue = document.getElementById("concurrency-value");

        let currentFiles = [];

        // åˆå§‹åŒ– API æœåŠ¡å™¨åˆ—è¡¨
        renderApiServers();

        // åˆå§‹åŒ–æŠ˜å å±•å¼€åŠŸèƒ½
        initCollapsibleApiServers();

        // åˆå§‹åŒ–æœåŠ¡å™¨çŠ¶æ€ç›‘æ§
        initServerStatusMonitoring();

        // åˆå§‹åŒ–ä»»åŠ¡æ—¥å¿—åŠŸèƒ½
        initTaskLogging();

        // ä»»åŠ¡æ—¥å¿—åŠŸèƒ½
        function initTaskLogging() {
          // æ·»åŠ ä»»åŠ¡æ—¥å¿—
          window.addTaskLog = function (message, type = "info") {
            const taskLog = document.getElementById("task-log");
            if (taskLog) {
              const timestamp = new Date().toLocaleTimeString();
              const logEntry = document.createElement("div");
              logEntry.className = `mb-1 ${getLogTypeClass(type)}`;
              logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;

              taskLog.appendChild(logEntry);
              taskLog.scrollTop = taskLog.scrollHeight;

              // é™åˆ¶æ—¥å¿—æ¡æ•°ï¼Œé¿å…å†…å­˜æ³„æ¼
              const logEntries = taskLog.children;
              if (logEntries.length > 100) {
                taskLog.removeChild(logEntries[0]);
              }
            }
          };

          // è·å–æ—¥å¿—ç±»å‹æ ·å¼
          function getLogTypeClass(type) {
            switch (type) {
              case "success":
                return "text-green-600";
              case "error":
                return "text-red-600";
              case "warning":
                return "text-yellow-600";
              case "info":
                return "text-blue-600";
              default:
                return "text-gray-600";
            }
          }

          // æ›´æ–°æœåŠ¡å™¨ç›‘æ§æ˜¾ç¤º
          window.updateServerMonitor = function (serverStatuses) {
            const serverMonitor = document.getElementById("server-monitor");
            if (serverMonitor && serverStatuses) {
              serverMonitor.innerHTML = "";

              Object.values(serverStatuses).forEach((server, index) => {
                const serverDiv = document.createElement("div");
                serverDiv.className = "p-2 bg-white border rounded text-xs";

                let statusIcon = "ğŸŸ¢";
                let statusColor = "text-green-600";
                switch (server.status) {
                  case "idle":
                    statusIcon = "ğŸŸ¢";
                    statusColor = "text-green-600";
                    break;
                  case "busy":
                    statusIcon = "ğŸŸ¡";
                    statusColor = "text-yellow-600";
                    break;
                  case "full":
                    statusIcon = "ğŸ”´";
                    statusColor = "text-red-600";
                    break;
                  case "error":
                    statusIcon = "âŒ";
                    statusColor = "text-red-600";
                    break;
                }

                serverDiv.innerHTML = `
                  <div class="font-medium truncate text-xs">${server.name}</div>
                  <div class="${statusColor} text-xs">${statusIcon} ${server.status}</div>
                  <div class="text-gray-500 text-xs">è´Ÿè½½: ${server.load}/${server.max_load}</div>
                  <div class="text-gray-500 text-xs">å®Œæˆ: ${server.completed_tasks}</div>
                `;
                serverMonitor.appendChild(serverDiv);
              });
            }
          };
        }

        // æœåŠ¡å™¨çŠ¶æ€ç›‘æ§åŠŸèƒ½
        function initServerStatusMonitoring() {
          // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€æ˜¾ç¤º
          window.updateServerStatus = function (
            serverIndex,
            status,
            load = 0,
            maxLoad = 1
          ) {
            const statusElement = document.getElementById(
              `server-status-${serverIndex}`
            );
            if (statusElement) {
              let statusText = "";
              let statusClass = "";

              switch (status) {
                case "idle":
                  statusText = "ğŸŸ¢ ç©ºé—²";
                  statusClass = "bg-green-100 text-green-800";
                  break;
                case "busy":
                  statusText = `ğŸŸ¡ å¿™ç¢Œ (${load}/${maxLoad})`;
                  statusClass = "bg-yellow-100 text-yellow-800";
                  break;
                case "full":
                  statusText = `ğŸ”´ æ»¡è½½ (${load}/${maxLoad})`;
                  statusClass = "bg-red-100 text-red-800";
                  break;
                case "error":
                  statusText = "âŒ é”™è¯¯";
                  statusClass = "bg-red-100 text-red-800";
                  break;
                default:
                  statusText = "âšª æœªçŸ¥";
                  statusClass = "bg-gray-100 text-gray-800";
              }

              statusElement.textContent = statusText;
              statusElement.className = `px-2 py-1 text-xs rounded ${statusClass}`;
            }
          };

          // æ‰¹é‡æ›´æ–°æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€
          window.updateAllServerStatus = function (serverStatuses) {
            serverStatuses.forEach((status, index) => {
              updateServerStatus(
                index,
                status.status,
                status.load,
                status.maxLoad
              );
            });
          };

          // é‡ç½®æ‰€æœ‰æœåŠ¡å™¨çŠ¶æ€ä¸ºç©ºé—²
          window.resetAllServerStatus = function () {
            for (let i = 0; i < apiServers.length; i++) {
              updateServerStatus(i, "idle");
            }
          };
        }

        // æŠ˜å å±•å¼€åŠŸèƒ½
        function initCollapsibleApiServers() {
          const header = document.getElementById("api-servers-header");
          const content = document.getElementById("api-servers-content");
          const arrow = document.getElementById("api-servers-arrow");
          const status = document.getElementById("api-servers-status");

          let isExpanded = false;

          header.addEventListener("click", function () {
            isExpanded = !isExpanded;

            if (isExpanded) {
              content.classList.add("expanded");
              arrow.classList.add("rotated");
              status.textContent = "ç‚¹å‡»æŠ˜å ";
            } else {
              content.classList.remove("expanded");
              arrow.classList.remove("rotated");
              status.textContent = "ç‚¹å‡»å±•å¼€";
            }
          });
        }

        // å¹¶å‘æ§åˆ¶æ»‘å—
        concurrencySlider.addEventListener("input", function () {
          concurrencyValue.textContent = this.value;
        });

        // æ·»åŠ  API æœåŠ¡å™¨
        addApiBtn.addEventListener("click", function () {
          showAddServerModal();
        });

        // å¯¼å‡º/å¯¼å…¥é…ç½®åŠŸèƒ½
        const exportConfigBtn = document.getElementById("export-config");
        const importConfigBtn = document.getElementById("import-config");
        const configFileInput = document.getElementById("config-file-input");

        // å¯¼å‡ºé…ç½®
        exportConfigBtn.addEventListener("click", function () {
          if (apiServers.length === 0) {
            alert("æ²¡æœ‰æœåŠ¡å™¨é…ç½®å¯ä»¥å¯¼å‡ºï¼");
            return;
          }

          const config = {
            version: "1.0",
            exportTime: new Date().toISOString(),
            servers: apiServers,
            currentServerIndex: currentServerIndex,
          };

          const blob = new Blob([JSON.stringify(config, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `tts-servers-config-${
            new Date().toISOString().split("T")[0]
          }.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          alert(`æˆåŠŸå¯¼å‡º ${apiServers.length} ä¸ªæœåŠ¡å™¨é…ç½®ï¼`);
        });

        // å¯¼å…¥é…ç½®
        importConfigBtn.addEventListener("click", function () {
          configFileInput.click();
        });

        configFileInput.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const config = JSON.parse(e.target.result);

              // éªŒè¯é…ç½®æ ¼å¼
              if (!config.servers || !Array.isArray(config.servers)) {
                throw new Error("æ— æ•ˆçš„é…ç½®æ–‡ä»¶æ ¼å¼ï¼šç¼ºå°‘æœåŠ¡å™¨åˆ—è¡¨");
              }

              // éªŒè¯æœåŠ¡å™¨é…ç½®æ ¼å¼
              for (let i = 0; i < config.servers.length; i++) {
                const server = config.servers[i];
                if (!server.name || !server.url) {
                  throw new Error(
                    `æœåŠ¡å™¨é…ç½® ${i + 1} ç¼ºå°‘å¿…è¦å­—æ®µï¼ˆname, urlï¼‰`
                  );
                }
              }

              // ç¡®è®¤å¯¼å…¥
              const confirmMessage = `å³å°†å¯¼å…¥ ${config.servers.length} ä¸ªæœåŠ¡å™¨é…ç½®ã€‚\n\nè¿™å°†è¦†ç›–å½“å‰çš„æœåŠ¡å™¨é…ç½®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`;
              if (confirm(confirmMessage)) {
                apiServers = config.servers;
                currentServerIndex = config.currentServerIndex || 0;

                // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
                if (currentServerIndex >= apiServers.length) {
                  currentServerIndex = 0;
                }

                saveApiServersToStorage();
                renderApiServers();

                alert(`æˆåŠŸå¯¼å…¥ ${config.servers.length} ä¸ªæœåŠ¡å™¨é…ç½®ï¼`);
              }
            } catch (error) {
              alert(`å¯¼å…¥å¤±è´¥ï¼š${error.message}`);
            }
          };
          reader.readAsText(file);

          // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
          e.target.value = "";
        });

        // æ˜¾ç¤ºæ·»åŠ æœåŠ¡å™¨æ¨¡æ€æ¡†
        function showAddServerModal() {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-backdrop";
          modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 w-96 max-w-md mx-4 modal-content shadow-xl">
              <h3 class="text-lg font-semibold mb-4 text-gray-800">æ·»åŠ  TTS æœåŠ¡å™¨</h3>
              <form id="add-server-form">
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1">æœåŠ¡å™¨åç§°</label>
                  <input type="text" id="server-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚: è¿œç¨‹æœåŠ¡å™¨" required>
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1">æœåŠ¡å™¨åœ°å€</label>
                  <input type="url" id="server-url" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="http://8.138.98.126:5050" required>
                </div>
                <div class="mb-6">
                  <label class="block text-sm font-medium text-gray-700 mb-1">API å¯†é’¥</label>
                  <input type="password" id="server-key" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¾“å…¥ API å¯†é’¥" required>
                </div>
                <div class="flex justify-end space-x-3">
                  <button type="button" id="cancel-btn" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">å–æ¶ˆ</button>
                  <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">æ·»åŠ </button>
                </div>
              </form>
            </div>
          `;

          document.body.appendChild(modal);

          // è¡¨å•æäº¤äº‹ä»¶
          document
            .getElementById("add-server-form")
            .addEventListener("submit", function (e) {
              e.preventDefault();

              const name = document.getElementById("server-name").value.trim();
              const url = document.getElementById("server-url").value.trim();
              const apiKey = document.getElementById("server-key").value.trim();

              if (!name || !url || !apiKey) {
                alert("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
                return;
              }

              const newServer = {
                id: "server_" + Date.now(),
                name: name,
                url: url,
                apiKey: apiKey,
                enabled: true,
              };

              apiServers.push(newServer);
              saveApiServersToStorage(); // ä¿å­˜åˆ°localStorage
              renderApiServers();
              document.body.removeChild(modal);
            });

          // å–æ¶ˆæŒ‰é’®äº‹ä»¶
          document
            .getElementById("cancel-btn")
            .addEventListener("click", function () {
              document.body.removeChild(modal);
            });

          // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
          modal.addEventListener("click", function (e) {
            if (e.target === modal) {
              document.body.removeChild(modal);
            }
          });

          // èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
          document.getElementById("server-name").focus();

          // ESC é”®å…³é—­æ¨¡æ€æ¡†
          const handleKeyDown = function (e) {
            if (e.key === "Escape") {
              document.body.removeChild(modal);
              document.removeEventListener("keydown", handleKeyDown);
            }
          };
          document.addEventListener("keydown", handleKeyDown);

          // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
          const originalRemoveChild = modal.removeChild;
          modal.removeChild = function () {
            document.removeEventListener("keydown", handleKeyDown);
            return originalRemoveChild.apply(this, arguments);
          };
        }

        // æ¸²æŸ“ API æœåŠ¡å™¨åˆ—è¡¨
        function renderApiServers() {
          apiServersList.innerHTML = "";

          // æ›´æ–°æœåŠ¡å™¨è®¡æ•°æ˜¾ç¤º
          const enabledCount = apiServers.filter(
            (server) => server.enabled
          ).length;
          const totalCount = apiServers.length;
          const countElement = document.getElementById("api-servers-count");
          if (countElement) {
            countElement.textContent = `${enabledCount}/${totalCount} ä¸ªæœåŠ¡å™¨`;
            if (enabledCount === 0) {
              countElement.className =
                "px-2 py-1 text-xs bg-red-100 text-red-800 rounded";
            } else if (enabledCount === totalCount) {
              countElement.className =
                "px-2 py-1 text-xs bg-green-100 text-green-800 rounded";
            } else {
              countElement.className =
                "px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded";
            }
          }

          apiServers.forEach((server, index) => {
            const serverDiv = document.createElement("div");
            serverDiv.className =
              "flex items-center justify-between p-3 bg-white border rounded hover:bg-gray-50 transition-colors";
            serverDiv.innerHTML = `
              <div class="flex items-center space-x-3 flex-1">
                <div class="flex items-center space-x-2">
                  <span class="text-sm font-medium text-gray-900">${
                    server.name
                  }</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">#${
                    index + 1
                  }</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span class="text-xs text-gray-600 truncate max-w-xs">${
                    server.url
                  }</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="px-2 py-1 text-xs rounded ${
                    server.enabled
                      ? "bg-green-100 text-green-800"
                      : "bg-gray-100 text-gray-600"
                  }">
                    ${server.enabled ? "âœ… å¯ç”¨" : "âŒ ç¦ç”¨"}
                  </span>
                  ${
                    server.enabled
                      ? '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">âš¡ è´Ÿè½½å‡è¡¡</span>'
                      : ""
                  }
                  <span class="px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded" id="server-status-${index}">
                    ğŸŸ¢ ç©ºé—²
                  </span>
                </div>
              </div>
              <div class="flex space-x-1 ml-2">
                <button onclick="toggleServer(${index})" class="px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                  ${server.enabled ? "ç¦ç”¨" : "å¯ç”¨"}
                </button>
                <button onclick="removeServer(${index})" class="px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                  åˆ é™¤
                </button>
              </div>
            `;
            apiServersList.appendChild(serverDiv);
          });

          // æ˜¾ç¤ºè´Ÿè½½å‡è¡¡è¯´æ˜
          if (enabledCount > 0) {
            const infoDiv = document.createElement("div");
            infoDiv.className =
              "mt-3 p-3 bg-blue-50 border border-blue-200 rounded text-sm";
            infoDiv.innerHTML = `
              <div class="flex items-center space-x-2 mb-2">
                <span class="text-blue-800 font-medium">ğŸ’¡ æ™ºèƒ½è´Ÿè½½å‡è¡¡</span>
                <span class="px-2 py-1 text-xs bg-blue-200 text-blue-800 rounded">${enabledCount}/${totalCount} æœåŠ¡å™¨</span>
              </div>
              <div class="text-xs text-blue-700 space-y-1">
                <p>â€¢ åŠ¨æ€ä»»åŠ¡åˆ†é…ï¼šæ ¹æ®æœåŠ¡å™¨å®æ—¶è´Ÿè½½çŠ¶æ€åˆ†é…ä»»åŠ¡</p>
                <p>â€¢ å¹¶å‘æ§åˆ¶ï¼šæ¯ä¸ªæœåŠ¡å™¨æœ€å¤šåŒæ—¶å¤„ç† ${
                  document.getElementById("concurrency-slider")?.value || 1
                } ä¸ªä»»åŠ¡</p>
                <p>â€¢ è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼šæœåŠ¡å™¨æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–å¯ç”¨æœåŠ¡å™¨</p>
                <p>â€¢ å®æ—¶ç›‘æ§ï¼šæ˜¾ç¤ºæ¯ä¸ªæœåŠ¡å™¨çš„å½“å‰çŠ¶æ€å’Œè´Ÿè½½æƒ…å†µ</p>
              </div>
            `;
            apiServersList.appendChild(infoDiv);
          }
        }

        // æ³¨æ„ï¼šå·²ç§»é™¤å•é€‰æŒ‰é’®ï¼Œç°åœ¨ä½¿ç”¨è´Ÿè½½å‡è¡¡æ¨¡å¼
        // æ‰€æœ‰å¯ç”¨çš„æœåŠ¡å™¨éƒ½ä¼šå‚ä¸è´Ÿè½½å‡è¡¡

        // åˆ‡æ¢æœåŠ¡å™¨å¯ç”¨çŠ¶æ€
        window.toggleServer = function (index) {
          apiServers[index].enabled = !apiServers[index].enabled;
          saveApiServersToStorage(); // ä¿å­˜åˆ°localStorage
          renderApiServers();
        };

        // åˆ é™¤æœåŠ¡å™¨
        window.removeServer = function (index) {
          if (apiServers.length <= 1) {
            alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæœåŠ¡å™¨");
            return;
          }
          if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæœåŠ¡å™¨å—ï¼Ÿ")) {
            apiServers.splice(index, 1);
            if (currentServerIndex >= apiServers.length) {
              currentServerIndex = 0;
            }
            saveApiServersToStorage(); // ä¿å­˜åˆ°localStorage
            renderApiServers();
          }
        };

        // è·å–å½“å‰æ´»åŠ¨æœåŠ¡å™¨
        function getCurrentServer() {
          return apiServers[currentServerIndex];
        }

        // è¯­é€Ÿæ»‘å—äº‹ä»¶
        speedSlider.addEventListener("input", (e) => {
          speedValue.textContent = parseFloat(e.target.value).toFixed(1) + "x";
        });

        // ç›®å½•åç§°éªŒè¯
        function validateDirectoryName(name) {
          if (!name || name.trim() === "") {
            return { valid: true, name: "" }; // ç©ºåç§°è¡¨ç¤ºä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆ
          }

          // ç§»é™¤å‰åç©ºæ ¼
          const cleanName = name.trim();

          // æ£€æŸ¥æ˜¯å¦åŒ…å«éæ³•å­—ç¬¦
          const invalidChars = /[<>:"/\\|?*\x00-\x1f]/;
          if (invalidChars.test(cleanName)) {
            return {
              valid: false,
              error: 'ç›®å½•åç§°ä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦: < > : " / \\ | ? * ç­‰',
            };
          }

          // æ£€æŸ¥é•¿åº¦
          if (cleanName.length > 50) {
            return {
              valid: false,
              error: "ç›®å½•åç§°ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦",
            };
          }

          return { valid: true, name: cleanName };
        }

        // æ–‡ä»¶é€‰æ‹©
        selectBtn.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", (e) => {
          currentFiles = Array.from(e.target.files);
          convertBtn.disabled = currentFiles.length === 0;
        });

        // å¼€å§‹è½¬æ¢
        convertBtn.addEventListener("click", async () => {
          if (currentFiles.length === 0) return;

          // éªŒè¯ç›®å½•åç§°
          const dirValidation = validateDirectoryName(customDirectory.value);
          if (!dirValidation.valid) {
            alert(dirValidation.error);
            return;
          }

          const formData = new FormData();
          currentFiles.forEach((file) => formData.append("files", file));
          formData.append(
            "voice",
            document.getElementById("voice-model").value
          );
          formData.append(
            "speed",
            document.getElementById("speed-slider").value
          );
          formData.append("custom_directory", dirValidation.name);

          // æ·»åŠ  API æœåŠ¡å™¨ä¿¡æ¯
          const enabledServers = apiServers.filter((server) => server.enabled);
          formData.append("api_servers", JSON.stringify(enabledServers));
          formData.append(
            "concurrency",
            document.getElementById("concurrency-slider").value
          );

          // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
          progressSection.classList.remove("hidden");
          progressContainer.innerHTML = `
             <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
               <h3 class="text-lg font-semibold text-blue-800 mb-2">ğŸ“ æ‰¹é‡å¤„ç†ä¿¡æ¯</h3>
               <p class="text-sm text-blue-700" id="batch-info">æ­£åœ¨åˆå§‹åŒ–æ‰¹é‡å¤„ç†...</p>
             </div>
             
             <!-- ä»»åŠ¡æ—¥å¿—åŒºåŸŸ -->
             <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
               <h3 class="text-lg font-semibold text-gray-800 mb-2">ğŸ“‹ ä»»åŠ¡æ—¥å¿—</h3>
               <div id="task-log" class="max-h-48 overflow-y-auto bg-white border rounded p-3 text-sm font-mono">
                 <div class="text-gray-500">ç­‰å¾…ä»»åŠ¡å¼€å§‹...</div>
               </div>
             </div>
             
             
             <div id="file-list" style="display: none;">
               ${currentFiles
                 .map(
                   (file) => `
                       <div class="mb-4 p-3 border rounded" id="progress-${file.name}">
                           <div class="flex justify-between items-center mb-1">
                               <span class="font-medium">${file.name}</span>
                               <span class="text-lg" id="status-${file.name}">â³</span>
                           </div>
                           <div class="text-xs text-blue-600 mt-1" id="api-details-${file.name}">ç­‰å¾…å¤„ç†</div>
                       </div>
                   `
                 )
                 .join("")}
             </div>
           `;

          // ç¦ç”¨è½¬æ¢æŒ‰é’®
          convertBtn.disabled = true;
          convertBtn.textContent = "è½¬æ¢ä¸­...";

          let batchId = null;
          let progressInterval = null;

          try {
            // æäº¤æ–‡ä»¶å¹¶ç­‰å¾…å“åº”
            const response = await axios.post("/upload", formData);

            if (response.data && response.data.batch_id) {
              batchId = response.data.batch_id;
              const batchDir = response.data.batch_directory;

              // æ›´æ–°æ‰¹é‡ä¿¡æ¯
              const isCustomDir = customDirectory.value.trim() !== "";
              const enabledServers = apiServers.filter(
                (server) => server.enabled
              );
              const concurrency =
                document.getElementById("concurrency-slider").value;
              document.getElementById("batch-info").innerHTML = `
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                   <div>
                     <strong>æ‰¹æ¬¡ID:</strong> ${batchId}<br>
                     <strong>å­˜å‚¨ç›®å½•:</strong> ${batchDir}<br>
                     <strong>ç›®å½•ç±»å‹:</strong> ${
                       isCustomDir ? "è‡ªå®šä¹‰ç›®å½•" : "è‡ªåŠ¨ç”Ÿæˆ"
                     }<br>
                     <strong>APIæœåŠ¡å™¨:</strong> ${
                       enabledServers.length
                     } ä¸ªå¯ç”¨æœåŠ¡å™¨
                   </div>
                   <div>
                     <strong>ä»»åŠ¡è¿›åº¦:</strong> <span id="task-progress">0/${
                       currentFiles.length
                     }</span><br>
                     <strong>æ–‡ä»¶æ•°é‡:</strong> ${
                       currentFiles.length
                     } ä¸ªæ–‡ä»¶<br>
                     <strong>å¹¶å‘åº¦:</strong> ${concurrency} ä¸ªçº¿ç¨‹<br>
                     <strong>å¤„ç†æ¨¡å¼:</strong> åŠ¨æ€è´Ÿè½½å‡è¡¡å¹¶å‘å¤„ç†
                   </div>
                 </div>
               `;

              // æ·»åŠ ä»»åŠ¡å¼€å§‹æ—¥å¿—
              addTaskLog(
                `ğŸš€ å¼€å§‹æ‰¹é‡å¤„ç† - ${currentFiles.length} ä¸ªæ–‡ä»¶ï¼Œ${enabledServers.length} ä¸ªæœåŠ¡å™¨ï¼Œå¹¶å‘åº¦: ${concurrency}`,
                "info"
              );

              // å¼€å§‹è½®è¯¢è¿›åº¦
              progressInterval = setInterval(async () => {
                try {
                  const progressResponse = await axios.get(
                    `/progress/${batchId}`
                  );

                  // æ£€æŸ¥å“åº”çŠ¶æ€
                  if (progressResponse.status === 404) {
                    clearInterval(progressInterval);
                    addTaskLog(
                      "âš ï¸ ä»»åŠ¡å·²ä¸­æ–­ - æœåŠ¡å™¨é‡å¯å¯¼è‡´ä»»åŠ¡çŠ¶æ€ä¸¢å¤±",
                      "warning"
                    );
                    document.getElementById("batch-info").innerHTML += `
                      <br><br>
                      <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <strong>âš ï¸ ä»»åŠ¡å·²ä¸­æ–­</strong><br>
                        æœåŠ¡å™¨é‡å¯å¯¼è‡´ä»»åŠ¡çŠ¶æ€ä¸¢å¤±ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶
                      </div>
                    `;
                    return;
                  }

                  const progressData = progressResponse.data;

                  // è·å–æœåŠ¡å™¨çŠ¶æ€
                  try {
                    const serverStatusResponse = await axios.get(
                      `/server_status/${batchId}`
                    );
                    if (
                      serverStatusResponse.data &&
                      serverStatusResponse.data.server_statuses
                    ) {
                      updateServerMonitor(
                        serverStatusResponse.data.server_statuses
                      );
                    }
                  } catch (error) {
                    // æœåŠ¡å™¨çŠ¶æ€è·å–å¤±è´¥ï¼Œä¸å½±å“ä¸»æµç¨‹
                  }

                  // æ›´æ–°ä»»åŠ¡è¿›åº¦
                  const completedCount = progressData.completed_files || 0;
                  const totalCount =
                    progressData.total_files || currentFiles.length;
                  const taskProgressElement =
                    document.getElementById("task-progress");
                  if (taskProgressElement) {
                    taskProgressElement.textContent = `${completedCount}/${totalCount}`;
                  }

                  // æ›´æ–°æ¯ä¸ªæ–‡ä»¶çš„è¿›åº¦
                  currentFiles.forEach((file) => {
                    const fileId = `${batchId}_${file.name}`;
                    const fileProgress = progressData.files[fileId];

                    if (fileProgress) {
                      const statusElement = document.getElementById(
                        `status-${file.name}`
                      );
                      const apiDetails = document.getElementById(
                        `api-details-${file.name}`
                      );

                      // æ›´æ–°å¤„ç†é˜¶æ®µä¿¡æ¯
                      if (fileProgress.stage) {
                        apiDetails.textContent = fileProgress.stage;
                      }

                      // æ›´æ–°çŠ¶æ€å›¾æ ‡å¹¶è®°å½•æ—¥å¿—
                      if (fileProgress.status === "waiting") {
                        statusElement.textContent = "â³";
                        if (!fileProgress.stage) {
                          apiDetails.textContent = "ç­‰å¾…å¤„ç†";
                        }
                      } else if (fileProgress.status === "processing") {
                        statusElement.textContent = "ğŸ”„";
                        if (!fileProgress.stage) {
                          apiDetails.textContent = "æ­£åœ¨å¤„ç†...";
                        } else if (fileProgress.stage.includes("å¼€å§‹å¤„ç†")) {
                          // è®°å½•ä»»åŠ¡å¼€å§‹æ—¥å¿—
                          const serverName = fileProgress.stage
                            ? fileProgress.stage.match(
                                /æœåŠ¡å™¨: ([^)]+)/
                              )?.[1] || "æœªçŸ¥æœåŠ¡å™¨"
                            : "æœªçŸ¥æœåŠ¡å™¨";
                          addTaskLog(
                            `ğŸ”„ ${file.name} å¼€å§‹å¤„ç† (æœåŠ¡å™¨: ${serverName})`,
                            "info"
                          );
                        }
                      } else if (fileProgress.status === "completed") {
                        statusElement.textContent = "âœ…";
                        apiDetails.textContent = "è½¬æ¢å®Œæˆ";

                        // è®°å½•ä»»åŠ¡å®Œæˆæ—¥å¿—
                        const serverName = fileProgress.stage
                          ? fileProgress.stage.match(/æœåŠ¡å™¨: ([^)]+)/)?.[1] ||
                            "æœªçŸ¥æœåŠ¡å™¨"
                          : "æœªçŸ¥æœåŠ¡å™¨";
                        const processingTime = fileProgress.stage
                          ? fileProgress.stage.match(/è€—æ—¶: ([\d.]+)ç§’/)?.[1] ||
                            "æœªçŸ¥"
                          : "æœªçŸ¥";

                        addTaskLog(
                          `âœ… ${file.name} è½¬æ¢æˆåŠŸ (æœåŠ¡å™¨: ${serverName}, è€—æ—¶: ${processingTime}ç§’)`,
                          "success"
                        );
                      } else if (fileProgress.status === "failed") {
                        statusElement.textContent = "âŒ";
                        apiDetails.textContent = "è½¬æ¢å¤±è´¥";

                        // è®°å½•ä»»åŠ¡å¤±è´¥æ—¥å¿—
                        const serverName = fileProgress.stage
                          ? fileProgress.stage.match(/æœåŠ¡å™¨: ([^)]+)/)?.[1] ||
                            "æœªçŸ¥æœåŠ¡å™¨"
                          : "æœªçŸ¥æœåŠ¡å™¨";
                        addTaskLog(
                          `âŒ ${file.name} è½¬æ¢å¤±è´¥ (æœåŠ¡å™¨: ${serverName})`,
                          "error"
                        );
                      }
                    }
                  });

                  // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
                  if (
                    progressData.completed_files >= progressData.total_files
                  ) {
                    clearInterval(progressInterval);
                    addTaskLog("ğŸ‰ æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæˆï¼", "success");

                    // æ˜¾ç¤ºå®Œæˆä¿¡æ¯
                    const successCount = Object.values(
                      progressData.files
                    ).filter((f) => f.status === "completed").length;
                    const failCount = Object.values(progressData.files).filter(
                      (f) => f.status === "failed"
                    ).length;

                    // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
                    const fileList = document.getElementById("file-list");
                    if (fileList) {
                      fileList.style.display = "block";
                    }

                    let retryButton = "";
                    if (failCount > 0) {
                      retryButton = `
                          <br>
                          <button id="retry-failed-btn" 
                                  class="mt-2 px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">
                            ğŸ”„ é‡è¯•å¤±è´¥æ–‡ä»¶ (${failCount} ä¸ª)
                          </button>
                        `;
                    }

                    document.getElementById("batch-info").innerHTML += `
                       <br><br>
                       <div class="p-3 bg-green-50 border border-green-200 rounded">
                         <strong>âœ… æ‰¹é‡å¤„ç†å®Œæˆ!</strong><br>
                         æˆåŠŸ: ${successCount} ä¸ªæ–‡ä»¶<br>
                         å¤±è´¥: ${failCount} ä¸ªæ–‡ä»¶
                         ${retryButton}
                       </div>
                     `;

                    // æ·»åŠ é‡è¯•æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
                    if (failCount > 0) {
                      document
                        .getElementById("retry-failed-btn")
                        .addEventListener("click", function () {
                          retryFailedFiles(batchId);
                        });
                    }

                    // é‡æ–°å¯ç”¨è½¬æ¢æŒ‰é’®
                    convertBtn.disabled = false;
                    convertBtn.textContent = "å¼€å§‹è½¬æ¢";

                    return; // é‡è¦ï¼šä»»åŠ¡å®Œæˆåç«‹å³è¿”å›ï¼Œåœæ­¢è½®è¯¢
                  }
                } catch (error) {
                  console.error("è·å–è¿›åº¦å¤±è´¥:", error);

                  // å¦‚æœæ˜¯404é”™è¯¯ï¼Œè¯´æ˜æ‰¹æ¬¡ä¸å­˜åœ¨
                  if (error.response && error.response.status === 404) {
                    clearInterval(progressInterval);
                    document.getElementById("batch-info").innerHTML += `
                      <br><br>
                      <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <strong>âš ï¸ ä»»åŠ¡å·²ä¸­æ–­</strong><br>
                        æœåŠ¡å™¨é‡å¯å¯¼è‡´ä»»åŠ¡çŠ¶æ€ä¸¢å¤±ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶
                      </div>
                    `;
                    return;
                  }
                }
              }, 1000);
            }
          } catch (error) {
            console.error("ä¸Šä¼ å¤±è´¥:", error);
            // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
            currentFiles.forEach((file) => {
              const statusElement = document.getElementById(
                `status-${file.name}`
              );
              const progressBar = document.querySelector(
                `#progress-${file.name} .progress-bar`
              );
              const progressText = document.getElementById(
                `progress-text-${file.name}`
              );

              statusElement.textContent = "è½¬æ¢å¤±è´¥";
              progressBar.style.width = "100%";
              progressBar.className =
                "progress-bar bg-red-600 h-2.5 rounded-full transition-all duration-300";
              progressText.textContent = "100%";
            });

            if (progressInterval) {
              clearInterval(progressInterval);
            }
          } finally {
            // é‡æ–°å¯ç”¨è½¬æ¢æŒ‰é’®
            convertBtn.disabled = false;
            convertBtn.textContent = "å¼€å§‹è½¬æ¢";
          }
        });
      });

      // é‡è¯•å¤±è´¥æ–‡ä»¶çš„å‡½æ•°
      function retryFailedFiles(batchId) {
        const retryBtn = document.getElementById("retry-failed-btn");
        if (retryBtn) {
          retryBtn.disabled = true;
          retryBtn.textContent = "ğŸ”„ é‡è¯•ä¸­...";
        }

        // è·å–å½“å‰é…ç½®
        const enabledServers = apiServers.filter((server) => server.enabled);
        const concurrency = document.getElementById("concurrency").value;
        const voice = document.getElementById("voice").value;
        const speed = document.getElementById("speed").value;

        // å‡†å¤‡è¡¨å•æ•°æ®
        const formData = new FormData();
        formData.append("batch_id", batchId);
        formData.append("api_servers", JSON.stringify(enabledServers));
        formData.append("concurrency", concurrency);
        formData.append("voice", voice);
        formData.append("speed", speed);

        // å‘é€é‡è¯•è¯·æ±‚
        axios
          .post("/retry_failed", formData)
          .then((response) => {
            if (response.data.success) {
              // æ›´æ–°æ‰¹é‡ä¿¡æ¯æ˜¾ç¤º
              document.getElementById("batch-info").innerHTML = `
                          <div class="p-3 bg-blue-50 border border-blue-200 rounded">
                              <strong>ğŸ”„ é‡è¯•å¤„ç†ä¸­...</strong><br>
                              æ­£åœ¨é‡è¯• ${response.data.retry_files} ä¸ªå¤±è´¥æ–‡ä»¶<br>
                              å¤„ç†æ¨¡å¼: åŠ¨æ€è´Ÿè½½å‡è¡¡å¹¶å‘å¤„ç†
                          </div>
                      `;

              // éšè—æ–‡ä»¶åˆ—è¡¨ï¼Œé‡æ–°å¼€å§‹è½®è¯¢
              const fileList = document.getElementById("file-list");
              if (fileList) {
                fileList.style.display = "none";
              }

              // å¼€å§‹è½®è¯¢è¿›åº¦
              startProgressPolling(batchId);
            } else {
              alert("é‡è¯•å¤±è´¥: " + response.data.error);
              if (retryBtn) {
                retryBtn.disabled = false;
                retryBtn.textContent = "ğŸ”„ é‡è¯•å¤±è´¥æ–‡ä»¶";
              }
            }
          })
          .catch((error) => {
            console.error("é‡è¯•è¯·æ±‚å¤±è´¥:", error);
            alert("é‡è¯•è¯·æ±‚å¤±è´¥: " + error.message);
            if (retryBtn) {
              retryBtn.disabled = false;
              retryBtn.textContent = "ğŸ”„ é‡è¯•å¤±è´¥æ–‡ä»¶";
            }
          });
      }

      // å¼€å§‹è½®è¯¢è¿›åº¦çš„å‡½æ•°ï¼ˆä»ä¸»è½¬æ¢é€»è¾‘ä¸­æå–ï¼‰
      function startProgressPolling(batchId) {
        const progressInterval = setInterval(async () => {
          try {
            const response = await axios.get(`/progress/${batchId}`);
            const data = response.data;

            // æ›´æ–°æ‰¹é‡ä¿¡æ¯
            document.getElementById("batch-info").innerHTML = `
                      <div class="p-3 bg-blue-50 border border-blue-200 rounded">
                          <strong>ğŸ“ æ‰¹é‡å¤„ç†ä¿¡æ¯</strong><br>
                          æ‰¹æ¬¡ID: ${data.batch_id}<br>
                          å½“å‰å¤„ç†: ç¬¬ ${data.current_file}/${data.total_files} ä¸ªæ–‡ä»¶<br>
                          å¤„ç†æ¨¡å¼: åŠ¨æ€è´Ÿè½½å‡è¡¡å¹¶å‘å¤„ç†
                      </div>
                  `;

            // æ›´æ–°æ–‡ä»¶çŠ¶æ€
            Object.values(data.files).forEach((file) => {
              const statusElement = document.getElementById(
                `status-${file.filename}`
              );
              const progressBar = document.querySelector(
                `#progress-${file.filename} .progress-bar`
              );
              const progressText = document.getElementById(
                `progress-text-${file.filename}`
              );

              if (statusElement && progressBar && progressText) {
                // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„å›¾æ ‡å’Œé¢œè‰²
                let statusIcon = "â³";
                let statusColor = "bg-gray-400";

                if (file.status === "completed") {
                  statusIcon = "âœ…";
                  statusColor = "bg-green-600";
                } else if (file.status === "failed") {
                  statusIcon = "âŒ";
                  statusColor = "bg-red-600";
                } else if (file.status === "processing") {
                  statusIcon = "ğŸ”„";
                  statusColor = "bg-blue-600";
                }

                statusElement.textContent = `${statusIcon} ${
                  file.stage || file.status
                }`;
                progressBar.style.width = `${file.progress}%`;
                progressBar.className = `progress-bar ${statusColor} h-2.5 rounded-full transition-all duration-300`;
                progressText.textContent = `${file.progress}%`;
              }
            });

            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
            if (data.completed_files >= data.total_files) {
              clearInterval(progressInterval);

              // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
              const fileList = document.getElementById("file-list");
              if (fileList) {
                fileList.style.display = "block";
              }

              // ç»Ÿè®¡æˆåŠŸå’Œå¤±è´¥çš„æ–‡ä»¶
              const files = Object.values(data.files);
              const successCount = files.filter(
                (f) => f.status === "completed"
              ).length;
              const failCount = files.filter(
                (f) => f.status === "failed"
              ).length;

              let retryButton = "";
              if (failCount > 0) {
                retryButton = `
                              <br>
                              <button id="retry-failed-btn" 
                                      class="mt-2 px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">
                                  ğŸ”„ é‡è¯•å¤±è´¥æ–‡ä»¶ (${failCount} ä¸ª)
                              </button>
                          `;
              }

              document.getElementById("batch-info").innerHTML += `
                          <br><br>
                          <div class="p-3 bg-green-50 border border-green-200 rounded">
                              <strong>âœ… æ‰¹é‡å¤„ç†å®Œæˆ!</strong><br>
                              æˆåŠŸ: ${successCount} ä¸ªæ–‡ä»¶<br>
                              å¤±è´¥: ${failCount} ä¸ªæ–‡ä»¶
                              ${retryButton}
                          </div>
                      `;

              // æ·»åŠ é‡è¯•æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
              if (failCount > 0) {
                document
                  .getElementById("retry-failed-btn")
                  .addEventListener("click", function () {
                    retryFailedFiles(batchId);
                  });
              }
            }
          } catch (error) {
            console.error("è·å–è¿›åº¦å¤±è´¥:", error);

            if (error.response && error.response.status === 404) {
              clearInterval(progressInterval);
              document.getElementById("batch-info").innerHTML += `
                          <br><br>
                          <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                              <strong>âš ï¸ ä»»åŠ¡å·²ä¸­æ–­</strong><br>
                              æœåŠ¡å™¨é‡å¯å¯¼è‡´ä»»åŠ¡çŠ¶æ€ä¸¢å¤±ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶
                          </div>
                      `;
            }
          }
        }, 1000);
      }
    </script>
  </body>
</html>
