<!DOCTYPE html>
<html>
  <head>
    <title>TTSè½¬æ¢å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
      .progress-bar {
        transition: width 0.3s ease;
      }

      /* æ¨¡æ€æ¡†æ ·å¼ */
      .modal-backdrop {
        backdrop-filter: blur(2px);
      }

      .modal-content {
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .batch-badge {
        background-color: #eff6ff;
        color: #1e40af;
      }
      /* è‡ªå®šä¹‰æ»‘å—æ ·å¼ */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
        cursor: pointer;
      }
      input[type="range"]::-webkit-slider-track {
        background: #e5e7eb;
        height: 8px;
        border-radius: 4px;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        background: #3b82f6;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        cursor: pointer;
      }
      input[type="range"]::-moz-range-track {
        background: #e5e7eb;
        height: 8px;
        border-radius: 4px;
        border: none;
      }
      input[type="range"]::-moz-range-thumb {
        background: #3b82f6;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        cursor: pointer;
        border: none;
      }
      /* é€‰æ‹©æ¡†æ ·å¼ */
      select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-2xl font-bold text-blue-600 mb-4">Markdownæ‰¹é‡è½¬MP3</h1>

      <!-- åŠŸèƒ½è¯´æ˜ -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <h2 class="text-lg font-semibold text-blue-800 mb-2">
          âœ¨ æ™ºèƒ½æ–‡æœ¬å¤„ç†
        </h2>
        <div class="text-sm text-blue-700 space-y-1">
          <p>â€¢ è‡ªåŠ¨ç§»é™¤ Markdown è¯­æ³•æ ‡è®°ï¼ˆ**ç²—ä½“**ã€*æ–œä½“*ã€`ä»£ç `ç­‰ï¼‰</p>
          <p>â€¢ è‡ªåŠ¨ç§»é™¤è¡¨æƒ…ç¬¦å· ğŸ˜ŠğŸ‰</p>
          <p>â€¢ è‡ªåŠ¨ç§»é™¤ URL é“¾æ¥</p>
          <p>â€¢ è‡ªåŠ¨åˆå¹¶ä¸ºå•è¡Œæ–‡æœ¬ï¼Œä¼˜åŒ–è¯­éŸ³æ’­æ”¾æ•ˆæœ</p>
        </div>
      </div>

      <!-- ä¸Šä¼ åŒºåŸŸ -->
      <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <input
          type="file"
          id="file-input"
          multiple
          accept=".md"
          class="hidden"
        />
        <div
          class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center"
        >
          <svg
            class="mx-auto h-12 w-12 text-gray-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
            />
          </svg>
          <p class="mt-2">æ‹–æ”¾Markdownæ–‡ä»¶åˆ°æ­¤å¤„æˆ–</p>
          <button
            id="select-files"
            class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            é€‰æ‹©æ–‡ä»¶
          </button>
        </div>

        <div class="mt-4">
          <label class="block mb-2 font-medium">ğŸ“ è‡ªå®šä¹‰ç›®å½•åç§°</label>
          <input
            type="text"
            id="custom-directory"
            placeholder="è¾“å…¥ç›®å½•åç§°ï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰"
            class="w-full p-2 border rounded"
          />
          <p class="text-xs text-gray-500 mt-1">
            æ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦
          </p>
        </div>

        <div class="mt-4">
          <label class="block mb-2 font-medium">ğŸ›ï¸ é€‰æ‹©éŸ³è‰²</label>
          <select id="voice-model" class="w-full p-2 border rounded">
            <option value="zh-CN-XiaoxiaoNeural">æ™“æ™“ (æ¸©æŸ”å¥³å£°)</option>
            <option value="zh-CN-YunyangNeural">äº‘æ‰¬ (ä¸“ä¸šç”·å£°)</option>
            <option value="zh-CN-YunjianNeural">äº‘å¥ (æ¿€æƒ…ç”·å£°)</option>
            <option value="zh-CN-XiaoyiNeural">æ™“ä¼Š (æ´»æ³¼å¥³å£°)</option>
            <option value="zh-CN-YunxiNeural">äº‘æºª (é˜³å…‰ç”·å£°)</option>
            <option value="zh-CN-liaoning-XiaobeiNeural">
              æ™“åŒ— (ä¸œåŒ—å¥³å£°)
            </option>
            <option value="zh-CN-YunfengNeural">äº‘æ« (æˆç†Ÿç”·å£°)</option>
            <option value="zh-CN-XiaochenNeural">æ™“è¾° (æ¸…æ–°å¥³å£°)</option>
            <option value="zh-CN-YunhaoNeural">äº‘çš“ (ç¨³é‡ç”·å£°)</option>
            <option value="zh-CN-XiaohanNeural">æ™“æ¶µ (çŸ¥æ€§å¥³å£°)</option>
          </select>
        </div>

        <div class="mt-4">
          <label class="block mb-2 font-medium">ğŸ”— TTS API æœåŠ¡å™¨ç®¡ç†</label>
          <div class="border rounded p-3 bg-gray-50">
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm font-medium">API æœåŠ¡å™¨åˆ—è¡¨</span>
              <button
                type="button"
                id="add-api-btn"
                class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600"
              >
                + æ·»åŠ æœåŠ¡å™¨
              </button>
            </div>
            <div id="api-servers-list" class="space-y-2">
              <!-- API æœåŠ¡å™¨åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="mt-3">
              <label class="block text-sm font-medium mb-1">å¹¶å‘æ§åˆ¶</label>
              <div class="flex items-center space-x-4">
                <input
                  type="range"
                  id="concurrency-slider"
                  min="1"
                  max="5"
                  value="1"
                  class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                />
                <span
                  id="concurrency-value"
                  class="text-sm font-medium text-gray-600 min-w-[2rem]"
                  >1</span
                >
                <span class="text-xs text-gray-500">å¹¶å‘æ•°</span>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <label class="block mb-2 font-medium">âš¡ è¯­é€Ÿè°ƒèŠ‚</label>
          <div class="flex items-center space-x-4">
            <input
              type="range"
              id="speed-slider"
              min="0.5"
              max="2.0"
              step="0.1"
              value="1.0"
              class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <span
              id="speed-value"
              class="text-sm font-medium text-gray-600 min-w-[3rem]"
              >1.0x</span
            >
          </div>
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>0.5x</span>
            <span>1.0x</span>
            <span>2.0x</span>
          </div>
        </div>

        <button
          id="start-convert"
          class="mt-4 w-full py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
          disabled
        >
          å¼€å§‹è½¬æ¢
        </button>
      </div>

      <!-- è¿›åº¦æ˜¾ç¤º -->
      <div
        id="progress-section"
        class="hidden bg-white p-6 rounded-lg shadow-md"
      >
        <h2 class="text-xl font-semibold mb-4">è½¬æ¢è¿›åº¦</h2>
        <div id="progress-container"></div>
      </div>
    </div>

    <script>
      // API æœåŠ¡å™¨ç®¡ç†
      let apiServers = [];
      let currentServerIndex = 0;

      // ä¿å­˜APIæœåŠ¡å™¨é…ç½®åˆ°localStorage
      function saveApiServersToStorage() {
        try {
          localStorage.setItem("tts_api_servers", JSON.stringify(apiServers));
          localStorage.setItem(
            "tts_current_server_index",
            currentServerIndex.toString()
          );
        } catch (error) {
          console.error("ä¿å­˜APIæœåŠ¡å™¨é…ç½®å¤±è´¥:", error);
        }
      }

      // ä»localStorageåŠ è½½APIæœåŠ¡å™¨é…ç½®
      function loadApiServersFromStorage() {
        try {
          const savedServers = localStorage.getItem("tts_api_servers");
          const savedIndex = localStorage.getItem("tts_current_server_index");

          if (savedServers) {
            apiServers = JSON.parse(savedServers);
            currentServerIndex = savedIndex ? parseInt(savedIndex) : 0;

            // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
            if (currentServerIndex >= apiServers.length) {
              currentServerIndex = 0;
            }
          } else {
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
            apiServers = [
              {
                id: "default",
                name: "é»˜è®¤æœåŠ¡å™¨",
                url: "http://127.0.0.1:5050",
                apiKey: "b77cf8cf852f4080bb56a4adcfc6a685",
                enabled: true,
              },
            ];
            currentServerIndex = 0;
            saveApiServersToStorage(); // ä¿å­˜é»˜è®¤é…ç½®
          }
        } catch (error) {
          console.error("åŠ è½½APIæœåŠ¡å™¨é…ç½®å¤±è´¥:", error);
          // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤é…ç½®
          apiServers = [
            {
              id: "default",
              name: "é»˜è®¤æœåŠ¡å™¨",
              url: "http://127.0.0.1:5050",
              apiKey: "b77cf8cf852f4080bb56a4adcfc6a685",
              enabled: true,
            },
          ];
          currentServerIndex = 0;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // é¦–å…ˆåŠ è½½ä¿å­˜çš„é…ç½®
        loadApiServersFromStorage();
        const fileInput = document.getElementById("file-input");
        const selectBtn = document.getElementById("select-files");
        const convertBtn = document.getElementById("start-convert");
        const progressSection = document.getElementById("progress-section");
        const progressContainer = document.getElementById("progress-container");
        const speedSlider = document.getElementById("speed-slider");
        const speedValue = document.getElementById("speed-value");
        const customDirectory = document.getElementById("custom-directory");
        const addApiBtn = document.getElementById("add-api-btn");
        const apiServersList = document.getElementById("api-servers-list");
        const concurrencySlider = document.getElementById("concurrency-slider");
        const concurrencyValue = document.getElementById("concurrency-value");

        let currentFiles = [];

        // åˆå§‹åŒ– API æœåŠ¡å™¨åˆ—è¡¨
        renderApiServers();

        // å¹¶å‘æ§åˆ¶æ»‘å—
        concurrencySlider.addEventListener("input", function () {
          concurrencyValue.textContent = this.value;
        });

        // æ·»åŠ  API æœåŠ¡å™¨
        addApiBtn.addEventListener("click", function () {
          showAddServerModal();
        });

        // æ˜¾ç¤ºæ·»åŠ æœåŠ¡å™¨æ¨¡æ€æ¡†
        function showAddServerModal() {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-backdrop";
          modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 w-96 max-w-md mx-4 modal-content shadow-xl">
              <h3 class="text-lg font-semibold mb-4 text-gray-800">æ·»åŠ  TTS æœåŠ¡å™¨</h3>
              <form id="add-server-form">
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1">æœåŠ¡å™¨åç§°</label>
                  <input type="text" id="server-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚: è¿œç¨‹æœåŠ¡å™¨" required>
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1">æœåŠ¡å™¨åœ°å€</label>
                  <input type="url" id="server-url" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="http://8.138.98.126:5050" required>
                </div>
                <div class="mb-6">
                  <label class="block text-sm font-medium text-gray-700 mb-1">API å¯†é’¥</label>
                  <input type="password" id="server-key" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¾“å…¥ API å¯†é’¥" required>
                </div>
                <div class="flex justify-end space-x-3">
                  <button type="button" id="cancel-btn" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">å–æ¶ˆ</button>
                  <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">æ·»åŠ </button>
                </div>
              </form>
            </div>
          `;

          document.body.appendChild(modal);

          // è¡¨å•æäº¤äº‹ä»¶
          document
            .getElementById("add-server-form")
            .addEventListener("submit", function (e) {
              e.preventDefault();

              const name = document.getElementById("server-name").value.trim();
              const url = document.getElementById("server-url").value.trim();
              const apiKey = document.getElementById("server-key").value.trim();

              if (!name || !url || !apiKey) {
                alert("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
                return;
              }

              const newServer = {
                id: "server_" + Date.now(),
                name: name,
                url: url,
                apiKey: apiKey,
                enabled: true,
              };

              apiServers.push(newServer);
              saveApiServersToStorage(); // ä¿å­˜åˆ°localStorage
              renderApiServers();
              document.body.removeChild(modal);
            });

          // å–æ¶ˆæŒ‰é’®äº‹ä»¶
          document
            .getElementById("cancel-btn")
            .addEventListener("click", function () {
              document.body.removeChild(modal);
            });

          // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
          modal.addEventListener("click", function (e) {
            if (e.target === modal) {
              document.body.removeChild(modal);
            }
          });

          // èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
          document.getElementById("server-name").focus();

          // ESC é”®å…³é—­æ¨¡æ€æ¡†
          const handleKeyDown = function (e) {
            if (e.key === "Escape") {
              document.body.removeChild(modal);
              document.removeEventListener("keydown", handleKeyDown);
            }
          };
          document.addEventListener("keydown", handleKeyDown);

          // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
          const originalRemoveChild = modal.removeChild;
          modal.removeChild = function () {
            document.removeEventListener("keydown", handleKeyDown);
            return originalRemoveChild.apply(this, arguments);
          };
        }

        // æ¸²æŸ“ API æœåŠ¡å™¨åˆ—è¡¨
        function renderApiServers() {
          apiServersList.innerHTML = "";
          apiServers.forEach((server, index) => {
            const serverDiv = document.createElement("div");
            serverDiv.className =
              "flex items-center justify-between p-2 bg-white border rounded";
            serverDiv.innerHTML = `
              <div class="flex items-center space-x-2">
                <span class="text-sm font-medium">${server.name}</span>
                <span class="text-xs text-gray-500">${server.url}</span>
                <span class="px-2 py-1 text-xs rounded ${
                  server.enabled
                    ? "bg-green-100 text-green-800"
                    : "bg-gray-100 text-gray-600"
                }">
                  ${server.enabled ? "å¯ç”¨" : "ç¦ç”¨"}
                </span>
                ${
                  server.enabled
                    ? '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">è´Ÿè½½å‡è¡¡</span>'
                    : ""
                }
              </div>
              <div class="flex space-x-1">
                <button onclick="toggleServer(${index})" class="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600">
                  ${server.enabled ? "ç¦ç”¨" : "å¯ç”¨"}
                </button>
                <button onclick="removeServer(${index})" class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">
                  åˆ é™¤
                </button>
              </div>
            `;
            apiServersList.appendChild(serverDiv);
          });

          // æ˜¾ç¤ºè´Ÿè½½å‡è¡¡è¯´æ˜
          const enabledCount = apiServers.filter(
            (server) => server.enabled
          ).length;
          if (enabledCount > 1) {
            const infoDiv = document.createElement("div");
            infoDiv.className =
              "mt-2 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-700";
            infoDiv.innerHTML = `ğŸ’¡ è´Ÿè½½å‡è¡¡æ¨¡å¼ï¼š${enabledCount} ä¸ªå¯ç”¨çš„æœåŠ¡å™¨å°†è‡ªåŠ¨åˆ†é…å¤„ç†ä»»åŠ¡`;
            apiServersList.appendChild(infoDiv);
          }
        }

        // æ³¨æ„ï¼šå·²ç§»é™¤å•é€‰æŒ‰é’®ï¼Œç°åœ¨ä½¿ç”¨è´Ÿè½½å‡è¡¡æ¨¡å¼
        // æ‰€æœ‰å¯ç”¨çš„æœåŠ¡å™¨éƒ½ä¼šå‚ä¸è´Ÿè½½å‡è¡¡

        // åˆ‡æ¢æœåŠ¡å™¨å¯ç”¨çŠ¶æ€
        window.toggleServer = function (index) {
          apiServers[index].enabled = !apiServers[index].enabled;
          saveApiServersToStorage(); // ä¿å­˜åˆ°localStorage
          renderApiServers();
        };

        // åˆ é™¤æœåŠ¡å™¨
        window.removeServer = function (index) {
          if (apiServers.length <= 1) {
            alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæœåŠ¡å™¨");
            return;
          }
          if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæœåŠ¡å™¨å—ï¼Ÿ")) {
            apiServers.splice(index, 1);
            if (currentServerIndex >= apiServers.length) {
              currentServerIndex = 0;
            }
            saveApiServersToStorage(); // ä¿å­˜åˆ°localStorage
            renderApiServers();
          }
        };

        // è·å–å½“å‰æ´»åŠ¨æœåŠ¡å™¨
        function getCurrentServer() {
          return apiServers[currentServerIndex];
        }

        // è¯­é€Ÿæ»‘å—äº‹ä»¶
        speedSlider.addEventListener("input", (e) => {
          speedValue.textContent = parseFloat(e.target.value).toFixed(1) + "x";
        });

        // ç›®å½•åç§°éªŒè¯
        function validateDirectoryName(name) {
          if (!name || name.trim() === "") {
            return { valid: true, name: "" }; // ç©ºåç§°è¡¨ç¤ºä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆ
          }

          // ç§»é™¤å‰åç©ºæ ¼
          const cleanName = name.trim();

          // æ£€æŸ¥æ˜¯å¦åŒ…å«éæ³•å­—ç¬¦
          const invalidChars = /[<>:"/\\|?*\x00-\x1f]/;
          if (invalidChars.test(cleanName)) {
            return {
              valid: false,
              error: 'ç›®å½•åç§°ä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦: < > : " / \\ | ? * ç­‰',
            };
          }

          // æ£€æŸ¥é•¿åº¦
          if (cleanName.length > 50) {
            return {
              valid: false,
              error: "ç›®å½•åç§°ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦",
            };
          }

          return { valid: true, name: cleanName };
        }

        // æ–‡ä»¶é€‰æ‹©
        selectBtn.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", (e) => {
          currentFiles = Array.from(e.target.files);
          convertBtn.disabled = currentFiles.length === 0;
        });

        // å¼€å§‹è½¬æ¢
        convertBtn.addEventListener("click", async () => {
          if (currentFiles.length === 0) return;

          // éªŒè¯ç›®å½•åç§°
          const dirValidation = validateDirectoryName(customDirectory.value);
          if (!dirValidation.valid) {
            alert(dirValidation.error);
            return;
          }

          const formData = new FormData();
          currentFiles.forEach((file) => formData.append("files", file));
          formData.append(
            "voice",
            document.getElementById("voice-model").value
          );
          formData.append(
            "speed",
            document.getElementById("speed-slider").value
          );
          formData.append("custom_directory", dirValidation.name);

          // æ·»åŠ  API æœåŠ¡å™¨ä¿¡æ¯
          const enabledServers = apiServers.filter((server) => server.enabled);
          formData.append("api_servers", JSON.stringify(enabledServers));
          formData.append(
            "concurrency",
            document.getElementById("concurrency-slider").value
          );

          // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
          progressSection.classList.remove("hidden");
          progressContainer.innerHTML = `
             <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
               <h3 class="text-lg font-semibold text-blue-800 mb-2">ğŸ“ æ‰¹é‡å¤„ç†ä¿¡æ¯</h3>
               <p class="text-sm text-blue-700" id="batch-info">æ­£åœ¨åˆå§‹åŒ–æ‰¹é‡å¤„ç†...</p>
             </div>
             <div id="file-list" style="display: none;">
               ${currentFiles
                 .map(
                   (file) => `
                       <div class="mb-4 p-3 border rounded" id="progress-${file.name}">
                           <div class="flex justify-between items-center mb-1">
                               <span class="font-medium">${file.name}</span>
                               <span class="text-lg" id="status-${file.name}">â³</span>
                           </div>
                           <div class="text-xs text-blue-600 mt-1" id="api-details-${file.name}">ç­‰å¾…å¤„ç†</div>
                       </div>
                   `
                 )
                 .join("")}
             </div>
           `;

          // ç¦ç”¨è½¬æ¢æŒ‰é’®
          convertBtn.disabled = true;
          convertBtn.textContent = "è½¬æ¢ä¸­...";

          let batchId = null;
          let progressInterval = null;

          try {
            // æäº¤æ–‡ä»¶å¹¶ç­‰å¾…å“åº”
            const response = await axios.post("/upload", formData);

            if (response.data && response.data.batch_id) {
              batchId = response.data.batch_id;
              const batchDir = response.data.batch_directory;

              // æ›´æ–°æ‰¹é‡ä¿¡æ¯
              const isCustomDir = customDirectory.value.trim() !== "";
              const enabledServers = apiServers.filter(
                (server) => server.enabled
              );
              const concurrency =
                document.getElementById("concurrency-slider").value;
              document.getElementById("batch-info").innerHTML = `
                 <strong>æ‰¹æ¬¡ID:</strong> ${batchId}<br>
                 <strong>å­˜å‚¨ç›®å½•:</strong> ${batchDir}<br>
                 <strong>ç›®å½•ç±»å‹:</strong> ${
                   isCustomDir ? "è‡ªå®šä¹‰ç›®å½•" : "è‡ªåŠ¨ç”Ÿæˆ"
                 }<br>
                 <strong>æ–‡ä»¶æ•°é‡:</strong> ${currentFiles.length} ä¸ªæ–‡ä»¶<br>
                 <strong>APIæœåŠ¡å™¨:</strong> ${
                   enabledServers.length
                 } ä¸ªå¯ç”¨æœåŠ¡å™¨<br>
                 <strong>å¹¶å‘åº¦:</strong> ${concurrency} ä¸ªçº¿ç¨‹<br>
                 <strong>å¤„ç†æ¨¡å¼:</strong> è´Ÿè½½å‡è¡¡å¹¶å‘å¤„ç†
               `;

              // å¼€å§‹è½®è¯¢è¿›åº¦
              progressInterval = setInterval(async () => {
                try {
                  const progressResponse = await axios.get(
                    `/progress/${batchId}`
                  );

                  // æ£€æŸ¥å“åº”çŠ¶æ€
                  if (progressResponse.status === 404) {
                    clearInterval(progressInterval);
                    document.getElementById("batch-info").innerHTML += `
                      <br><br>
                      <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <strong>âš ï¸ ä»»åŠ¡å·²ä¸­æ–­</strong><br>
                        æœåŠ¡å™¨é‡å¯å¯¼è‡´ä»»åŠ¡çŠ¶æ€ä¸¢å¤±ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶
                      </div>
                    `;
                    return;
                  }

                  const progressData = progressResponse.data;

                  // æ›´æ–°å½“å‰å¤„ç†æ–‡ä»¶ä¿¡æ¯
                  if (progressData.current_file > 0) {
                    const isCustomDir = customDirectory.value.trim() !== "";
                    const enabledServers = apiServers.filter(
                      (server) => server.enabled
                    );
                    const concurrency =
                      document.getElementById("concurrency-slider").value;
                    document.getElementById("batch-info").innerHTML = `
                       <strong>æ‰¹æ¬¡ID:</strong> ${batchId}<br>
                       <strong>å­˜å‚¨ç›®å½•:</strong> ${batchDir}<br>
                       <strong>ç›®å½•ç±»å‹:</strong> ${
                         isCustomDir ? "è‡ªå®šä¹‰ç›®å½•" : "è‡ªåŠ¨ç”Ÿæˆ"
                       }<br>
                       <strong>æ–‡ä»¶æ•°é‡:</strong> ${
                         currentFiles.length
                       } ä¸ªæ–‡ä»¶<br>
                       <strong>APIæœåŠ¡å™¨:</strong> ${
                         enabledServers.length
                       } ä¸ªå¯ç”¨æœåŠ¡å™¨<br>
                       <strong>å¹¶å‘åº¦:</strong> ${concurrency} ä¸ªçº¿ç¨‹<br>
                       <strong>å¤„ç†æ¨¡å¼:</strong> è´Ÿè½½å‡è¡¡å¹¶å‘å¤„ç†<br>
                       <strong>å½“å‰å¤„ç†:</strong> ç¬¬ ${
                         progressData.current_file
                       }/${progressData.total_files} ä¸ªæ–‡ä»¶
                     `;
                  }

                  // æ›´æ–°æ¯ä¸ªæ–‡ä»¶çš„è¿›åº¦
                  currentFiles.forEach((file) => {
                    const fileId = `${batchId}_${file.name}`;
                    const fileProgress = progressData.files[fileId];

                    if (fileProgress) {
                      const statusElement = document.getElementById(
                        `status-${file.name}`
                      );
                      const apiDetails = document.getElementById(
                        `api-details-${file.name}`
                      );

                      // æ›´æ–°å¤„ç†é˜¶æ®µä¿¡æ¯
                      if (fileProgress.stage) {
                        apiDetails.textContent = fileProgress.stage;
                      }

                      // æ›´æ–°çŠ¶æ€å›¾æ ‡
                      if (fileProgress.status === "waiting") {
                        statusElement.textContent = "â³";
                        if (!fileProgress.stage) {
                          apiDetails.textContent = "ç­‰å¾…å¤„ç†";
                        }
                      } else if (fileProgress.status === "processing") {
                        statusElement.textContent = "ğŸ”„";
                        if (!fileProgress.stage) {
                          apiDetails.textContent = "æ­£åœ¨å¤„ç†...";
                        }
                      } else if (fileProgress.status === "completed") {
                        statusElement.textContent = "âœ…";
                        apiDetails.textContent = "è½¬æ¢å®Œæˆ";
                      } else if (fileProgress.status === "failed") {
                        statusElement.textContent = "âŒ";
                        apiDetails.textContent = "è½¬æ¢å¤±è´¥";
                      }
                    }
                  });

                  // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
                  if (
                    progressData.completed_files >= progressData.total_files
                  ) {
                    clearInterval(progressInterval);

                    // æ˜¾ç¤ºå®Œæˆä¿¡æ¯
                    const successCount = Object.values(
                      progressData.files
                    ).filter((f) => f.status === "completed").length;
                    const failCount = Object.values(progressData.files).filter(
                      (f) => f.status === "failed"
                    ).length;

                    // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
                    const fileList = document.getElementById("file-list");
                    if (fileList) {
                      fileList.style.display = "block";
                    }

                    document.getElementById("batch-info").innerHTML += `
                       <br><br>
                       <div class="p-3 bg-green-50 border border-green-200 rounded">
                         <strong>âœ… æ‰¹é‡å¤„ç†å®Œæˆ!</strong><br>
                         æˆåŠŸ: ${successCount} ä¸ªæ–‡ä»¶<br>
                         å¤±è´¥: ${failCount} ä¸ªæ–‡ä»¶
                       </div>
                     `;
                  }
                } catch (error) {
                  console.error("è·å–è¿›åº¦å¤±è´¥:", error);

                  // å¦‚æœæ˜¯404é”™è¯¯ï¼Œè¯´æ˜æ‰¹æ¬¡ä¸å­˜åœ¨
                  if (error.response && error.response.status === 404) {
                    clearInterval(progressInterval);
                    document.getElementById("batch-info").innerHTML += `
                      <br><br>
                      <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <strong>âš ï¸ ä»»åŠ¡å·²ä¸­æ–­</strong><br>
                        æœåŠ¡å™¨é‡å¯å¯¼è‡´ä»»åŠ¡çŠ¶æ€ä¸¢å¤±ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶
                      </div>
                    `;
                    return;
                  }
                }
              }, 1000);
            }
          } catch (error) {
            console.error("ä¸Šä¼ å¤±è´¥:", error);
            // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
            currentFiles.forEach((file) => {
              const statusElement = document.getElementById(
                `status-${file.name}`
              );
              const progressBar = document.querySelector(
                `#progress-${file.name} .progress-bar`
              );
              const progressText = document.getElementById(
                `progress-text-${file.name}`
              );

              statusElement.textContent = "è½¬æ¢å¤±è´¥";
              progressBar.style.width = "100%";
              progressBar.className =
                "progress-bar bg-red-600 h-2.5 rounded-full transition-all duration-300";
              progressText.textContent = "100%";
            });

            if (progressInterval) {
              clearInterval(progressInterval);
            }
          } finally {
            // é‡æ–°å¯ç”¨è½¬æ¢æŒ‰é’®
            convertBtn.disabled = false;
            convertBtn.textContent = "å¼€å§‹è½¬æ¢";
          }
        });
      });
    </script>
  </body>
</html>
