<!DOCTYPE html>
<html>
  <head>
    <title>TTS转换工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
      .progress-bar {
        transition: width 0.3s ease;
      }

      /* 模态框样式 */
      .modal-backdrop {
        backdrop-filter: blur(2px);
      }

      .modal-content {
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .batch-badge {
        background-color: #eff6ff;
        color: #1e40af;
      }
      /* 自定义滑块样式 */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
        cursor: pointer;
      }
      input[type="range"]::-webkit-slider-track {
        background: #e5e7eb;
        height: 8px;
        border-radius: 4px;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        background: #3b82f6;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        cursor: pointer;
      }
      input[type="range"]::-moz-range-track {
        background: #e5e7eb;
        height: 8px;
        border-radius: 4px;
        border: none;
      }
      input[type="range"]::-moz-range-thumb {
        background: #3b82f6;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        cursor: pointer;
        border: none;
      }
      /* 选择框样式 */
      select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
      }

      /* 折叠展开动画样式 */
      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        opacity: 0;
      }

      .collapsible-content.expanded {
        max-height: 1000px;
        opacity: 1;
        transition: max-height 0.3s ease-in, opacity 0.3s ease-in;
      }

      .collapsible-arrow {
        transition: transform 0.3s ease;
      }

      .collapsible-arrow.rotated {
        transform: rotate(180deg);
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-2xl font-bold text-blue-600 mb-4">Markdown批量转MP3</h1>

      <!-- 上传区域 -->
      <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <input
          type="file"
          id="file-input"
          multiple
          accept=".md"
          class="hidden"
        />
        <div class="text-center">
          <button
            id="select-files"
            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-lg font-medium"
          >
            📁 选择Markdown文件
          </button>
          <p class="text-sm text-gray-500 mt-2">支持多选，自动处理文本格式</p>
        </div>

        <div class="mt-4">
          <label class="block mb-2 font-medium">📁 自定义目录名称</label>
          <input
            type="text"
            id="custom-directory"
            placeholder="输入目录名称（可选，留空则自动生成）"
            class="w-full p-2 border rounded"
          />
          <p class="text-xs text-gray-500 mt-1">
            支持中文、英文、数字、下划线，不能包含特殊字符
          </p>
        </div>

        <div class="mt-4">
          <label class="block mb-2 font-medium">🎛️ 选择音色</label>
          <select id="voice-model" class="w-full p-2 border rounded">
            <option value="zh-CN-XiaoxiaoNeural">晓晓 (温柔女声)</option>
            <option value="zh-CN-YunyangNeural">云扬 (专业男声)</option>
            <option value="zh-CN-YunjianNeural">云健 (激情男声)</option>
            <option value="zh-CN-XiaoyiNeural">晓伊 (活泼女声)</option>
            <option value="zh-CN-YunxiNeural">云溪 (阳光男声)</option>
            <option value="zh-CN-liaoning-XiaobeiNeural">
              晓北 (东北女声)
            </option>
            <option value="zh-CN-YunfengNeural">云枫 (成熟男声)</option>
            <option value="zh-CN-XiaochenNeural">晓辰 (清新女声)</option>
            <option value="zh-CN-YunhaoNeural">云皓 (稳重男声)</option>
            <option value="zh-CN-XiaohanNeural">晓涵 (知性女声)</option>
          </select>
          <div class="mt-2">
            <label class="block text-sm text-gray-600 mb-1">➕ 自定义音色</label>
            <div
              class="flex flex-col sm:flex-row sm:items-center sm:space-x-2 space-y-2 sm:space-y-0"
            >
              <input
                type="text"
                id="custom-voice-input"
                placeholder="输入声音模型名称，例如 zh-CN-ExampleNeural"
                class="w-full sm:flex-1 px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                id="add-custom-voice"
                type="button"
                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
              >
                保存音色
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">
              支持保存多个自定义音色，便于快速切换
            </p>
            <div id="custom-voice-list" class="mt-2 space-y-2 text-sm"></div>
          </div>
        </div>

        <!-- 负载均衡器状态监控 -->
        <div class="mt-4">
          <label class="block mb-2 font-medium">⚡ 负载均衡器状态</label>
          <div
            class="p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg"
          >
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center space-x-2">
                <span class="text-lg">🚀</span>
                <span class="font-medium text-blue-800">超简单负载均衡器</span>
                <span
                  class="px-2 py-1 text-xs bg-blue-200 text-blue-800 rounded"
                  >已启用</span
                >
              </div>
              <div class="text-xs text-blue-600">
                <span id="balancer-mode">简化模式</span>
              </div>
            </div>
            <div class="text-xs text-blue-700 space-y-1">
              <div class="grid grid-cols-2 gap-2">
                <div>• 任务派发：找到可用服务器 → 派发任务</div>
                <div>• 超时监控：每个任务最多等待300秒</div>
                <div>• 轮询检查：任务完成后释放服务器</div>
                <div>• 服务器选择：优先使用未用过的服务器</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 服务器状态监控 -->
        <div class="mt-4">
          <label class="block mb-2 font-medium">🖥️ 服务器状态监控</label>
          <div
            id="server-monitor"
            class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 p-3 bg-gray-50 border rounded"
          >
            <div class="text-gray-500 text-sm">等待服务器状态更新...</div>
          </div>
        </div>

        <div class="mt-4">
          <label class="block mb-2 font-medium">🔗 TTS API 服务器管理</label>
          <div class="border rounded bg-gray-50">
            <!-- 折叠头部 -->
            <div class="p-3">
              <div
                class="flex justify-between items-center cursor-pointer hover:bg-gray-100 transition-colors rounded p-2 -m-2"
                id="api-servers-header"
              >
                <div class="flex items-center space-x-2">
                  <span class="text-sm font-medium">API 服务器列表</span>
                  <span
                    id="api-servers-count"
                    class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded"
                    >0 个服务器</span
                  >
                </div>
                <div class="flex items-center space-x-2">
                  <span id="api-servers-status" class="text-xs text-gray-500"
                    >点击展开</span
                  >
                  <svg
                    id="api-servers-arrow"
                    class="w-4 h-4 text-gray-500 collapsible-arrow"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    ></path>
                  </svg>
                </div>
              </div>

              <!-- 并发控制 - 始终可见 -->
              <div class="mt-3">
                <label class="block text-sm font-medium mb-1"
                  >⚡ 并发控制</label
                >
                <div class="flex items-center space-x-4">
                  <input
                    type="range"
                    id="concurrency-slider"
                    min="1"
                    max="5"
                    value="1"
                    class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                  <span
                    id="concurrency-value"
                    class="text-sm font-medium text-gray-600 min-w-[2rem]"
                    >1</span
                  >
                  <span class="text-xs text-gray-500">并发数</span>
                </div>
              </div>

              <!-- 导出/导入控制 -->
              <div class="mt-3">
                <label class="block text-sm font-medium mb-2"
                  >📁 配置管理</label
                >
                <div class="flex items-center space-x-2">
                  <button
                    id="export-config"
                    class="px-3 py-1.5 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors"
                  >
                    📤 导出配置
                  </button>
                  <button
                    id="import-config"
                    class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
                  >
                    📥 导入配置
                  </button>
                  <input
                    type="file"
                    id="config-file-input"
                    accept=".json"
                    class="hidden"
                  />
                </div>
                <p class="text-xs text-gray-500 mt-1">
                  导出当前服务器配置为JSON文件，或从JSON文件导入配置
                </p>
              </div>
            </div>

            <!-- 折叠内容 -->
            <div id="api-servers-content" class="collapsible-content border-t">
              <div class="p-3">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-medium">服务器配置</span>
                  <button
                    type="button"
                    id="add-api-btn"
                    class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600"
                  >
                    + 添加服务器
                  </button>
                </div>
                <div
                  id="api-servers-list"
                  class="space-y-2 max-h-96 overflow-y-auto"
                >
                  <!-- API 服务器列表将在这里动态生成 -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <label class="block mb-2 font-medium">⚡ 语速调节</label>
          <div class="flex items-center space-x-4">
            <input
              type="range"
              id="speed-slider"
              min="0.5"
              max="2.0"
              step="0.1"
              value="1.0"
              class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
            />
            <span
              id="speed-value"
              class="text-sm font-medium text-gray-600 min-w-[3rem]"
              >1.0x</span
            >
          </div>
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>0.5x</span>
            <span>1.0x</span>
            <span>2.0x</span>
          </div>
        </div>

        <button
          id="start-convert"
          class="mt-4 w-full py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
          disabled
        >
          开始转换
        </button>
      </div>

      <!-- 文件夹管理区域 -->
      <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold text-gray-800">📦 文件夹管理</h2>
          <button
            id="refresh-folders"
            class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors text-sm"
          >
            🔄 刷新
          </button>
        </div>

        <div id="folders-list" class="space-y-3">
          <div class="text-center text-gray-500 py-8">
            <div
              class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"
            ></div>
            正在加载文件夹列表...
          </div>
        </div>
      </div>

      <!-- 进度显示 -->
      <div
        id="progress-section"
        class="hidden bg-white p-6 rounded-lg shadow-md"
      >
        <h2 class="text-xl font-semibold mb-4">转换进度</h2>
        <div id="progress-container"></div>
      </div>
    </div>

    <script>
      // API 服务器管理
      let apiServers = [];
      let currentServerIndex = 0;

      // 保存API服务器配置到localStorage
      function saveApiServersToStorage() {
        try {
          localStorage.setItem("tts_api_servers", JSON.stringify(apiServers));
          localStorage.setItem(
            "tts_current_server_index",
            currentServerIndex.toString()
          );
        } catch (error) {
          console.error("保存API服务器配置失败:", error);
        }
      }

      // 从localStorage加载API服务器配置
      function loadApiServersFromStorage() {
        try {
          const savedServers = localStorage.getItem("tts_api_servers");
          const savedIndex = localStorage.getItem("tts_current_server_index");

          if (savedServers) {
            apiServers = JSON.parse(savedServers);
            currentServerIndex = savedIndex ? parseInt(savedIndex) : 0;

            // 确保索引有效
            if (currentServerIndex >= apiServers.length) {
              currentServerIndex = 0;
            }
          } else {
            // 如果没有保存的配置，使用默认配置
            apiServers = [
              {
                id: "default",
                name: "默认服务器",
                url: "https://mytts.pages.dev",
                apiKey: "123321",
                enabled: true,
              },
            ];
            currentServerIndex = 0;
            saveApiServersToStorage(); // 保存默认配置
          }
        } catch (error) {
          console.error("加载API服务器配置失败:", error);
          // 出错时使用默认配置
          apiServers = [
            {
              id: "default",
              name: "默认服务器",
              url: "https://mytts.pages.dev",
              apiKey: "123321",
              enabled: true,
            },
          ];
          currentServerIndex = 0;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // 首先加载保存的配置
        loadApiServersFromStorage();
        const fileInput = document.getElementById("file-input");
        const selectBtn = document.getElementById("select-files");
        const convertBtn = document.getElementById("start-convert");
        const progressSection = document.getElementById("progress-section");
        const progressContainer = document.getElementById("progress-container");
        const speedSlider = document.getElementById("speed-slider");
        const speedValue = document.getElementById("speed-value");
        const customDirectory = document.getElementById("custom-directory");
        const addApiBtn = document.getElementById("add-api-btn");
        const apiServersList = document.getElementById("api-servers-list");
        const concurrencySlider = document.getElementById("concurrency-slider");
        const concurrencyValue = document.getElementById("concurrency-value");
        const voiceSelect = document.getElementById("voice-model");
        const customVoiceInput = document.getElementById("custom-voice-input");
        const addCustomVoiceBtn = document.getElementById("add-custom-voice");
        const customVoiceList = document.getElementById("custom-voice-list");

        const CUSTOM_VOICES_KEY = "tts_custom_voices";
        const SELECTED_VOICE_KEY = "tts_selected_voice";
        let customVoices = [];

        let currentFiles = [];

        initCustomVoiceManagement();

        // 初始化 API 服务器列表
        renderApiServers();

        // 初始化折叠展开功能
        initCollapsibleApiServers();

        // 初始化服务器状态监控
        initServerStatusMonitoring();

        // 初始化任务日志功能
        initTaskLogging();

        // 初始化文件夹管理功能
        initFolderManagement();

        function initCustomVoiceManagement() {
          loadCustomVoicesFromStorage();
          renderCustomVoices();
          restoreSelectedVoice();

          if (addCustomVoiceBtn) {
            addCustomVoiceBtn.addEventListener("click", handleAddCustomVoice);
          }

          if (customVoiceInput) {
            customVoiceInput.addEventListener("keydown", (event) => {
              if (event.key === "Enter") {
                event.preventDefault();
                handleAddCustomVoice();
              }
            });
          }

          if (voiceSelect) {
            voiceSelect.addEventListener("change", () => {
              localStorage.setItem(SELECTED_VOICE_KEY, voiceSelect.value);
            });
          }
        }

        function handleAddCustomVoice() {
          if (!customVoiceInput) return;
          const newVoice = customVoiceInput.value.trim();

          if (!newVoice) {
            alert("请输入要保存的声音模型名称");
            return;
          }

          if (customVoices.includes(newVoice)) {
            alert("该自定义音色已存在");
            customVoiceInput.value = "";
            return;
          }

          customVoices.push(newVoice);
          saveCustomVoicesToStorage();
          renderCustomVoices();

          if (voiceSelect) {
            voiceSelect.value = newVoice;
            localStorage.setItem(SELECTED_VOICE_KEY, newVoice);
          }

          customVoiceInput.value = "";
        }

        function removeCustomVoice(voice) {
          customVoices = customVoices.filter((item) => item !== voice);
          saveCustomVoicesToStorage();
          renderCustomVoices();
          ensureValidVoiceSelection();
        }

        function ensureValidVoiceSelection() {
          if (!voiceSelect) return;
          const currentValue = voiceSelect.value;
          const hasCurrent = Array.from(voiceSelect.options).some(
            (option) => option.value === currentValue
          );

          if (!hasCurrent && voiceSelect.options.length > 0) {
            voiceSelect.selectedIndex = 0;
            localStorage.setItem(SELECTED_VOICE_KEY, voiceSelect.value);
          }
        }

        function loadCustomVoicesFromStorage() {
          try {
            customVoices = [];
            const savedVoices = localStorage.getItem(CUSTOM_VOICES_KEY);
            if (savedVoices) {
              const parsed = JSON.parse(savedVoices);
              if (Array.isArray(parsed)) {
                customVoices = Array.from(
                  new Set(
                    parsed
                      .filter((item) => typeof item === "string")
                      .map((item) => item.trim())
                      .filter((item) => item)
                  )
                );
              }
            }
          } catch (error) {
            customVoices = [];
          }
        }

        function saveCustomVoicesToStorage() {
          try {
            localStorage.setItem(CUSTOM_VOICES_KEY, JSON.stringify(customVoices));
          } catch (error) {
            console.error("保存自定义音色失败:", error);
          }
        }

        function renderCustomVoices() {
          renderCustomVoiceOptions();
          renderCustomVoiceList();
        }

        function renderCustomVoiceOptions() {
          if (!voiceSelect) return;
          const existingGroup = voiceSelect.querySelector(
            "optgroup[data-custom='true']"
          );
          if (existingGroup) {
            existingGroup.remove();
          }

          if (customVoices.length === 0) {
            return;
          }

          const group = document.createElement("optgroup");
          group.label = "自定义音色";
          group.dataset.custom = "true";

          customVoices.forEach((voice) => {
            const option = document.createElement("option");
            option.value = voice;
            option.textContent = voice;
            group.appendChild(option);
          });

          voiceSelect.appendChild(group);
        }

        function renderCustomVoiceList() {
          if (!customVoiceList) return;

          customVoiceList.innerHTML = "";

          if (customVoices.length === 0) {
            const placeholder = document.createElement("div");
            placeholder.className = "text-xs text-gray-400";
            placeholder.textContent = "尚未保存自定义音色";
            customVoiceList.appendChild(placeholder);
            return;
          }

          customVoices.forEach((voice) => {
            const wrapper = document.createElement("div");
            wrapper.className =
              "flex items-center justify-between px-3 py-2 border rounded bg-white";

            const nameSpan = document.createElement("span");
            nameSpan.className = "text-gray-700 break-all pr-2";
            nameSpan.textContent = voice;

            const deleteBtn = document.createElement("button");
            deleteBtn.type = "button";
            deleteBtn.className =
              "text-xs text-red-600 hover:text-red-700 transition-colors";
            deleteBtn.textContent = "删除";
            deleteBtn.addEventListener("click", () => removeCustomVoice(voice));

            wrapper.appendChild(nameSpan);
            wrapper.appendChild(deleteBtn);
            customVoiceList.appendChild(wrapper);
          });
        }

        function restoreSelectedVoice() {
          if (!voiceSelect) return;
          const savedVoice = localStorage.getItem(SELECTED_VOICE_KEY);
          if (!savedVoice) {
            return;
          }

          const hasSaved = Array.from(voiceSelect.options).some(
            (option) => option.value === savedVoice
          );

          if (hasSaved) {
            voiceSelect.value = savedVoice;
          }
        }

        // 任务日志功能
        function initTaskLogging() {
          // 添加任务日志
          window.addTaskLog = function (message, type = "info") {
            const taskLog = document.getElementById("task-log");
            if (taskLog) {
              const timestamp = new Date().toLocaleTimeString();
              const logEntry = document.createElement("div");
              logEntry.className = `mb-1 ${getLogTypeClass(type)}`;
              logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;

              taskLog.appendChild(logEntry);
              taskLog.scrollTop = taskLog.scrollHeight;

              // 限制日志条数，避免内存泄漏
              const logEntries = taskLog.children;
              if (logEntries.length > 100) {
                taskLog.removeChild(logEntries[0]);
              }
            }
          };

          // 获取日志类型样式
          function getLogTypeClass(type) {
            switch (type) {
              case "success":
                return "text-green-600";
              case "error":
                return "text-red-600";
              case "warning":
                return "text-yellow-600";
              case "info":
                return "text-blue-600";
              default:
                return "text-gray-600";
            }
          }

          // 更新服务器监控显示
          window.updateServerMonitor = function (serverStatuses) {
            const serverMonitor = document.getElementById("server-monitor");
            if (serverMonitor && serverStatuses) {
              serverMonitor.innerHTML = "";

              Object.values(serverStatuses).forEach((server, index) => {
                const serverDiv = document.createElement("div");
                serverDiv.className = "p-2 bg-white border rounded text-xs";

                let statusIcon = "🟢";
                let statusColor = "text-green-600";
                switch (server.status) {
                  case "idle":
                    statusIcon = "🟢";
                    statusColor = "text-green-600";
                    break;
                  case "busy":
                    statusIcon = "🟡";
                    statusColor = "text-yellow-600";
                    break;
                  case "full":
                    statusIcon = "🔴";
                    statusColor = "text-red-600";
                    break;
                  case "error":
                    statusIcon = "❌";
                    statusColor = "text-red-600";
                    break;
                }

                const completed = server.completed_tasks ?? 0;
                const failed = server.failed_tasks ?? 0;
                const timeout = server.timeout_tasks ?? 0;
                serverDiv.innerHTML = `
                  <div class="font-medium truncate text-xs">${server.name}</div>
                  <div class="${statusColor} text-xs">${statusIcon} ${server.status}</div>
                  <div class="text-gray-500 text-xs">负载: ${server.load}/${server.max_load}</div>
                  <div class="text-gray-500 text-xs">完成: ${completed}</div>
                  <div class="text-gray-500 text-xs">超时: ${timeout}</div>
                  <div class="text-gray-500 text-xs">报错: ${failed}</div>
                `;
                serverMonitor.appendChild(serverDiv);
              });
            }
          };
        }

        // 服务器状态监控功能
        function initServerStatusMonitoring() {
          // 更新服务器状态显示
          window.updateServerStatus = function (
            serverIndex,
            status,
            load = 0,
            maxLoad = 1
          ) {
            const statusElement = document.getElementById(
              `server-status-${serverIndex}`
            );
            if (statusElement) {
              let statusText = "";
              let statusClass = "";

              switch (status) {
                case "idle":
                  statusText = "🟢 空闲";
                  statusClass = "bg-green-100 text-green-800";
                  break;
                case "busy":
                  statusText = `🟡 忙碌 (${load}/${maxLoad})`;
                  statusClass = "bg-yellow-100 text-yellow-800";
                  break;
                case "full":
                  statusText = `🔴 满载 (${load}/${maxLoad})`;
                  statusClass = "bg-red-100 text-red-800";
                  break;
                case "error":
                  statusText = "❌ 错误";
                  statusClass = "bg-red-100 text-red-800";
                  break;
                default:
                  statusText = "⚪ 未知";
                  statusClass = "bg-gray-100 text-gray-800";
              }

              statusElement.textContent = statusText;
              statusElement.className = `px-2 py-1 text-xs rounded ${statusClass}`;
            }
          };

          // 批量更新所有服务器状态
          window.updateAllServerStatus = function (serverStatuses) {
            serverStatuses.forEach((status, index) => {
              updateServerStatus(
                index,
                status.status,
                status.load,
                status.maxLoad
              );
            });
          };

          // 重置所有服务器状态为空闲
          window.resetAllServerStatus = function () {
            for (let i = 0; i < apiServers.length; i++) {
              updateServerStatus(i, "idle");
            }
          };
        }

        // 折叠展开功能
        function initCollapsibleApiServers() {
          const header = document.getElementById("api-servers-header");
          const content = document.getElementById("api-servers-content");
          const arrow = document.getElementById("api-servers-arrow");
          const status = document.getElementById("api-servers-status");

          let isExpanded = false;

          header.addEventListener("click", function () {
            isExpanded = !isExpanded;

            if (isExpanded) {
              content.classList.add("expanded");
              arrow.classList.add("rotated");
              status.textContent = "点击折叠";
            } else {
              content.classList.remove("expanded");
              arrow.classList.remove("rotated");
              status.textContent = "点击展开";
            }
          });
        }

        // 并发控制滑块
        concurrencySlider.addEventListener("input", function () {
          concurrencyValue.textContent = this.value;
        });

        // 添加 API 服务器
        addApiBtn.addEventListener("click", function () {
          showAddServerModal();
        });

        // 导出/导入配置功能
        const exportConfigBtn = document.getElementById("export-config");
        const importConfigBtn = document.getElementById("import-config");
        const configFileInput = document.getElementById("config-file-input");

        // 导出配置
        exportConfigBtn.addEventListener("click", function () {
          if (apiServers.length === 0) {
            alert("没有服务器配置可以导出！");
            return;
          }

          const config = {
            version: "1.0",
            exportTime: new Date().toISOString(),
            servers: apiServers,
            currentServerIndex: currentServerIndex,
          };

          const blob = new Blob([JSON.stringify(config, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `tts-servers-config-${
            new Date().toISOString().split("T")[0]
          }.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          alert(`成功导出 ${apiServers.length} 个服务器配置！`);
        });

        // 导入配置
        importConfigBtn.addEventListener("click", function () {
          configFileInput.click();
        });

        configFileInput.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const config = JSON.parse(e.target.result);

              // 验证配置格式
              if (!config.servers || !Array.isArray(config.servers)) {
                throw new Error("无效的配置文件格式：缺少服务器列表");
              }

              // 验证服务器配置格式
              for (let i = 0; i < config.servers.length; i++) {
                const server = config.servers[i];
                if (!server.name || !server.url) {
                  throw new Error(
                    `服务器配置 ${i + 1} 缺少必要字段（name, url）`
                  );
                }
              }

              // 确认导入
              const confirmMessage = `即将导入 ${config.servers.length} 个服务器配置。\n\n这将覆盖当前的服务器配置，是否继续？`;
              if (confirm(confirmMessage)) {
                apiServers = config.servers;
                currentServerIndex = config.currentServerIndex || 0;

                // 确保索引有效
                if (currentServerIndex >= apiServers.length) {
                  currentServerIndex = 0;
                }

                saveApiServersToStorage();
                renderApiServers();

                alert(`成功导入 ${config.servers.length} 个服务器配置！`);
              }
            } catch (error) {
              alert(`导入失败：${error.message}`);
            }
          };
          reader.readAsText(file);

          // 清空文件输入，允许重复选择同一文件
          e.target.value = "";
        });

        // 显示添加服务器模态框
        function showAddServerModal() {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-backdrop";
          modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 w-96 max-w-md mx-4 modal-content shadow-xl">
              <h3 class="text-lg font-semibold mb-4 text-gray-800">添加 TTS 服务器</h3>
              <form id="add-server-form">
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1">服务器名称</label>
                  <input type="text" id="server-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如: 远程服务器" required>
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-1">服务器地址</label>
                  <input type="url" id="server-url" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="http://8.138.98.126:5050" required>
                </div>
                <div class="mb-6">
                  <label class="block text-sm font-medium text-gray-700 mb-1">API 密钥</label>
                  <input type="password" id="server-key" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入 API 密钥" required>
                </div>
                <div class="flex justify-end space-x-3">
                  <button type="button" id="cancel-btn" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">取消</button>
                  <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">添加</button>
                </div>
              </form>
            </div>
          `;

          document.body.appendChild(modal);

          // 表单提交事件
          document
            .getElementById("add-server-form")
            .addEventListener("submit", function (e) {
              e.preventDefault();

              const name = document.getElementById("server-name").value.trim();
              const url = document.getElementById("server-url").value.trim();
              const apiKey = document.getElementById("server-key").value.trim();

              if (!name || !url || !apiKey) {
                alert("请填写所有字段");
                return;
              }

              const newServer = {
                id: "server_" + Date.now(),
                name: name,
                url: url,
                apiKey: apiKey,
                enabled: true,
              };

              apiServers.push(newServer);
              saveApiServersToStorage(); // 保存到localStorage
              renderApiServers();
              document.body.removeChild(modal);
            });

          // 取消按钮事件
          document
            .getElementById("cancel-btn")
            .addEventListener("click", function () {
              document.body.removeChild(modal);
            });

          // 点击背景关闭模态框
          modal.addEventListener("click", function (e) {
            if (e.target === modal) {
              document.body.removeChild(modal);
            }
          });

          // 聚焦到第一个输入框
          document.getElementById("server-name").focus();

          // ESC 键关闭模态框
          const handleKeyDown = function (e) {
            if (e.key === "Escape") {
              document.body.removeChild(modal);
              document.removeEventListener("keydown", handleKeyDown);
            }
          };
          document.addEventListener("keydown", handleKeyDown);

          // 清理事件监听器
          const originalRemoveChild = modal.removeChild;
          modal.removeChild = function () {
            document.removeEventListener("keydown", handleKeyDown);
            return originalRemoveChild.apply(this, arguments);
          };
        }

        // 渲染 API 服务器列表
        function renderApiServers() {
          apiServersList.innerHTML = "";

          // 更新服务器计数显示
          const enabledCount = apiServers.filter(
            (server) => server.enabled
          ).length;
          const totalCount = apiServers.length;
          const countElement = document.getElementById("api-servers-count");
          if (countElement) {
            countElement.textContent = `${enabledCount}/${totalCount} 个服务器`;
            if (enabledCount === 0) {
              countElement.className =
                "px-2 py-1 text-xs bg-red-100 text-red-800 rounded";
            } else if (enabledCount === totalCount) {
              countElement.className =
                "px-2 py-1 text-xs bg-green-100 text-green-800 rounded";
            } else {
              countElement.className =
                "px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded";
            }
          }

          apiServers.forEach((server, index) => {
            const serverDiv = document.createElement("div");
            serverDiv.className =
              "flex items-center justify-between p-3 bg-white border rounded hover:bg-gray-50 transition-colors";
            serverDiv.innerHTML = `
              <div class="flex items-center space-x-3 flex-1">
                <div class="flex items-center space-x-2">
                  <span class="text-sm font-medium text-gray-900">${
                    server.name
                  }</span>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">#${
                    index + 1
                  }</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span class="text-xs text-gray-600 truncate max-w-xs">${
                    server.url
                  }</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="px-2 py-1 text-xs rounded ${
                    server.enabled
                      ? "bg-green-100 text-green-800"
                      : "bg-gray-100 text-gray-600"
                  }">
                    ${server.enabled ? "✅ 启用" : "❌ 禁用"}
                  </span>
                  ${
                    server.enabled
                      ? '<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">⚡ 负载均衡</span>'
                      : ""
                  }
                  <span class="px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded" id="server-status-${index}">
                    🟢 空闲
                  </span>
                </div>
              </div>
              <div class="flex space-x-1 ml-2">
                <button onclick="toggleServer(${index})" class="px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                  ${server.enabled ? "禁用" : "启用"}
                </button>
                <button onclick="removeServer(${index})" class="px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                  删除
                </button>
              </div>
            `;
            apiServersList.appendChild(serverDiv);
          });

          // 显示负载均衡说明
          if (enabledCount > 0) {
            const infoDiv = document.createElement("div");
            infoDiv.className =
              "mt-3 p-3 bg-blue-50 border border-blue-200 rounded text-sm";
            infoDiv.innerHTML = `
              <div class="flex items-center space-x-2 mb-2">
                <span class="text-blue-800 font-medium">💡 智能负载均衡</span>
                <span class="px-2 py-1 text-xs bg-blue-200 text-blue-800 rounded">${enabledCount}/${totalCount} 服务器</span>
              </div>
              <div class="text-xs text-blue-700 space-y-1">
                <p>• 动态任务分配：根据服务器实时负载状态分配任务</p>
                <p>• 并发控制：每个服务器最多同时处理 ${
                  document.getElementById("concurrency-slider")?.value || 1
                } 个任务</p>
                <p>• 自动故障转移：服务器故障时自动切换到其他可用服务器</p>
                <p>• 实时监控：显示每个服务器的当前状态和负载情况</p>
              </div>
            `;
            apiServersList.appendChild(infoDiv);
          }
        }

        // 注意：已移除单选按钮，现在使用负载均衡模式
        // 所有启用的服务器都会参与负载均衡

        // 切换服务器启用状态
        window.toggleServer = function (index) {
          apiServers[index].enabled = !apiServers[index].enabled;
          saveApiServersToStorage(); // 保存到localStorage
          renderApiServers();
        };

        // 删除服务器
        window.removeServer = function (index) {
          if (apiServers.length <= 1) {
            alert("至少需要保留一个服务器");
            return;
          }
          if (confirm("确定要删除这个服务器吗？")) {
            apiServers.splice(index, 1);
            if (currentServerIndex >= apiServers.length) {
              currentServerIndex = 0;
            }
            saveApiServersToStorage(); // 保存到localStorage
            renderApiServers();
          }
        };

        // 获取当前活动服务器
        function getCurrentServer() {
          return apiServers[currentServerIndex];
        }

        // 语速滑块事件
        speedSlider.addEventListener("input", (e) => {
          speedValue.textContent = parseFloat(e.target.value).toFixed(1) + "x";
        });

        // 目录名称验证
        function validateDirectoryName(name) {
          if (!name || name.trim() === "") {
            return { valid: true, name: "" }; // 空名称表示使用自动生成
          }

          // 移除前后空格
          const cleanName = name.trim();

          // 检查是否包含非法字符
          const invalidChars = /[<>:"/\\|?*\x00-\x1f]/;
          if (invalidChars.test(cleanName)) {
            return {
              valid: false,
              error: '目录名称不能包含特殊字符: < > : " / \\ | ? * 等',
            };
          }

          // 检查长度
          if (cleanName.length > 50) {
            return {
              valid: false,
              error: "目录名称不能超过50个字符",
            };
          }

          return { valid: true, name: cleanName };
        }

        // 文件选择
        selectBtn.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", (e) => {
          currentFiles = Array.from(e.target.files);
          convertBtn.disabled = currentFiles.length === 0;
        });

        // 开始转换
        convertBtn.addEventListener("click", async () => {
          if (currentFiles.length === 0) return;

          // 验证目录名称
          const dirValidation = validateDirectoryName(customDirectory.value);
          if (!dirValidation.valid) {
            alert(dirValidation.error);
            return;
          }

          const formData = new FormData();
          currentFiles.forEach((file) => formData.append("files", file));
          formData.append(
            "voice",
            document.getElementById("voice-model").value
          );
          formData.append(
            "speed",
            document.getElementById("speed-slider").value
          );
          formData.append("custom_directory", dirValidation.name);

          // 添加 API 服务器信息
          const enabledServers = apiServers.filter((server) => server.enabled);
          formData.append("api_servers", JSON.stringify(enabledServers));
          formData.append(
            "concurrency",
            document.getElementById("concurrency-slider").value
          );

          // 显示进度区域
          progressSection.classList.remove("hidden");
          progressContainer.innerHTML = `
             <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
               <h3 class="text-lg font-semibold text-blue-800 mb-2">📁 批量处理信息</h3>
               <p class="text-sm text-blue-700" id="batch-info">正在初始化批量处理...</p>
             </div>
             
             <!-- 任务日志区域 -->
             <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
               <h3 class="text-lg font-semibold text-gray-800 mb-2">📋 任务日志</h3>
               <div id="task-log" class="max-h-48 overflow-y-auto bg-white border rounded p-3 text-sm font-mono">
                 <div class="text-gray-500">等待任务开始...</div>
               </div>
             </div>
             
             
             <div id="file-list" style="display: none;">
               ${currentFiles
                 .map(
                   (file) => `
                       <div class="mb-4 p-3 border rounded" id="progress-${file.name}">
                           <div class="flex justify-between items-center mb-1">
                               <span class="font-medium">${file.name}</span>
                               <span class="text-lg" id="status-${file.name}">⏳</span>
                           </div>
                           <div class="text-xs text-blue-600 mt-1" id="api-details-${file.name}">等待处理</div>
                       </div>
                   `
                 )
                 .join("")}
             </div>
           `;

          // 禁用转换按钮
          convertBtn.disabled = true;
          convertBtn.textContent = "转换中...";

          let batchId = null;
          let progressInterval = null;

          try {
            // 提交文件并等待响应
            const response = await axios.post("/upload", formData);

            if (response.data && response.data.batch_id) {
              batchId = response.data.batch_id;
              const batchDir = response.data.batch_directory;

              // 更新批量信息
              const isCustomDir = customDirectory.value.trim() !== "";
              const enabledServers = apiServers.filter(
                (server) => server.enabled
              );
              const concurrency =
                document.getElementById("concurrency-slider").value;
              document.getElementById("batch-info").innerHTML = `
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                   <div>
                     <strong>批次ID:</strong> ${batchId}<br>
                     <strong>存储目录:</strong> ${batchDir}<br>
                     <strong>目录类型:</strong> ${
                       isCustomDir ? "自定义目录" : "自动生成"
                     }<br>
                     <strong>API服务器:</strong> ${
                       enabledServers.length
                     } 个启用服务器
                   </div>
                   <div>
                     <strong>任务进度:</strong> <span id="task-progress">0/${
                       currentFiles.length
                     }</span><br>
                     <strong>文件数量:</strong> ${
                       currentFiles.length
                     } 个文件<br>
                     <strong>并发度:</strong> ${concurrency} 个线程<br>
                     <strong>处理模式:</strong> 动态负载均衡并发处理
                   </div>
                 </div>
               `;

              // 添加任务开始日志
              addTaskLog(
                `🚀 启动超简单负载均衡器 - ${currentFiles.length} 个文件，${enabledServers.length} 个服务器，并发度: ${concurrency}`,
                "info"
              );
              addTaskLog(
                `⚡ 负载均衡策略: 优先未用过的服务器 → 最久没用的服务器`,
                "info"
              );
              addTaskLog(
                `⏰ 超时设置: 每个任务最多等待300秒，超时自动重试`,
                "info"
              );

              // 开始轮询进度
              progressInterval = setInterval(async () => {
                try {
                  const progressResponse = await axios.get(
                    `/progress/${batchId}`
                  );

                  // 检查响应状态
                  if (progressResponse.status === 404) {
                    clearInterval(progressInterval);
                    addTaskLog(
                      "⚠️ 任务已中断 - 服务器重启导致任务状态丢失",
                      "warning"
                    );
                    document.getElementById("batch-info").innerHTML += `
                      <br><br>
                      <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <strong>⚠️ 任务已中断</strong><br>
                        服务器重启导致任务状态丢失，请重新上传文件
                      </div>
                    `;
                    return;
                  }

                  const progressData = progressResponse.data;

                  // 获取服务器状态
                  try {
                    const serverStatusResponse = await axios.get(
                      `/server_status/${batchId}`
                    );
                    if (
                      serverStatusResponse.data &&
                      serverStatusResponse.data.server_statuses
                    ) {
                      updateServerMonitor(
                        serverStatusResponse.data.server_statuses
                      );
                    }
                  } catch (error) {
                    // 服务器状态获取失败，不影响主流程
                  }

                  // 更新任务进度
                  const completedCount = progressData.completed_files || 0;
                  const totalCount =
                    progressData.total_files || currentFiles.length;
                  const taskProgressElement =
                    document.getElementById("task-progress");
                  if (taskProgressElement) {
                    taskProgressElement.textContent = `${completedCount}/${totalCount}`;
                  }

                  // 更新每个文件的进度
                  currentFiles.forEach((file) => {
                    const fileId = `${batchId}_${file.name}`;
                    const fileProgress = progressData.files[fileId];

                    if (fileProgress) {
                      const statusElement = document.getElementById(
                        `status-${file.name}`
                      );
                      const apiDetails = document.getElementById(
                        `api-details-${file.name}`
                      );

                      // 更新处理阶段信息
                      if (fileProgress.stage) {
                        apiDetails.textContent = fileProgress.stage;
                      }

                      // 更新状态图标并记录日志
                      if (fileProgress.status === "waiting") {
                        statusElement.textContent = "⏳";
                        if (!fileProgress.stage) {
                          apiDetails.textContent = "等待处理";
                        }
                      } else if (fileProgress.status === "processing") {
                        statusElement.textContent = "🔄";
                        if (!fileProgress.stage) {
                          apiDetails.textContent = "正在处理...";
                        } else if (fileProgress.stage.includes("开始处理")) {
                          // 记录任务开始日志
                          const serverName = fileProgress.stage
                            ? fileProgress.stage.match(
                                /服务器: ([^)]+)/
                              )?.[1] || "未知服务器"
                            : "未知服务器";
                          addTaskLog(
                            `🔄 ${file.name} 开始处理 (服务器: ${serverName})`,
                            "info"
                          );
                        }
                      } else if (fileProgress.status === "completed") {
                        statusElement.textContent = "✅";
                        apiDetails.textContent = "转换完成";

                        // 记录任务完成日志
                        const serverName = fileProgress.stage
                          ? fileProgress.stage.match(/服务器: ([^)]+)/)?.[1] ||
                            "未知服务器"
                          : "未知服务器";
                        const processingTime = fileProgress.stage
                          ? fileProgress.stage.match(/耗时: ([\d.]+)秒/)?.[1] ||
                            "未知"
                          : "未知";

                        addTaskLog(
                          `✅ ${file.name} 转换成功 (服务器: ${serverName}, 耗时: ${processingTime}秒)`,
                          "success"
                        );
                      } else if (fileProgress.status === "failed") {
                        statusElement.textContent = "❌";
                        apiDetails.textContent = "转换失败";

                        // 记录任务失败日志
                        const serverName = fileProgress.stage
                          ? fileProgress.stage.match(/服务器: ([^)]+)/)?.[1] ||
                            "未知服务器"
                          : "未知服务器";
                        addTaskLog(
                          `❌ ${file.name} 转换失败 (服务器: ${serverName})`,
                          "error"
                        );
                      }
                    }
                  });

                  // 检查是否全部完成
                  if (
                    progressData.completed_files >= progressData.total_files
                  ) {
                    clearInterval(progressInterval);
                    addTaskLog("🎉 超简单负载均衡器处理完成！", "success");
                    addTaskLog(
                      `📊 最终统计: 完成 ${progressData.completed_files}/${progressData.total_files} 个任务`,
                      "success"
                    );

                    // 显示完成信息
                    const successCount = Object.values(
                      progressData.files
                    ).filter((f) => f.status === "completed").length;
                    const failCount = Object.values(progressData.files).filter(
                      (f) => f.status === "failed"
                    ).length;

                    // 显示文件列表
                    const fileList = document.getElementById("file-list");
                    if (fileList) {
                      fileList.style.display = "block";
                    }

                    let retryButton = "";
                    if (failCount > 0) {
                      retryButton = `
                          <br>
                          <button id="retry-failed-btn" 
                                  class="mt-2 px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">
                            🔄 重试失败文件 (${failCount} 个)
                          </button>
                        `;
                    }

                    document.getElementById("batch-info").innerHTML += `
                       <br><br>
                       <div class="p-3 bg-green-50 border border-green-200 rounded">
                         <strong>✅ 超简单负载均衡器处理完成!</strong><br>
                         成功: ${successCount} 个文件<br>
                         失败: ${failCount} 个文件<br>
                         <div class="mt-2 text-xs text-green-700">
                           🚀 核心特性: 任务派发 → 300秒超时 → 轮询检查<br>
                           ⚡ 服务器策略: 优先未用过的服务器，确保公平分配
                         </div>
                         ${retryButton}
                       </div>
                     `;

                    // 添加重试按钮事件监听器
                    if (failCount > 0) {
                      document
                        .getElementById("retry-failed-btn")
                        .addEventListener("click", function () {
                          retryFailedFiles(batchId);
                        });
                    }

                    // 重新启用转换按钮
                    convertBtn.disabled = false;
                    convertBtn.textContent = "开始转换";

                    return; // 重要：任务完成后立即返回，停止轮询
                  }
                } catch (error) {
                  console.error("获取进度失败:", error);

                  // 如果是404错误，说明批次不存在
                  if (error.response && error.response.status === 404) {
                    clearInterval(progressInterval);
                    document.getElementById("batch-info").innerHTML += `
                      <br><br>
                      <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <strong>⚠️ 任务已中断</strong><br>
                        服务器重启导致任务状态丢失，请重新上传文件
                      </div>
                    `;
                    return;
                  }
                }
              }, 1000);
            }
          } catch (error) {
            console.error("上传失败:", error);
            // 显示错误状态
            currentFiles.forEach((file) => {
              const statusElement = document.getElementById(
                `status-${file.name}`
              );
              const progressBar = document.querySelector(
                `#progress-${file.name} .progress-bar`
              );
              const progressText = document.getElementById(
                `progress-text-${file.name}`
              );

              statusElement.textContent = "转换失败";
              progressBar.style.width = "100%";
              progressBar.className =
                "progress-bar bg-red-600 h-2.5 rounded-full transition-all duration-300";
              progressText.textContent = "100%";
            });

            if (progressInterval) {
              clearInterval(progressInterval);
            }
          } finally {
            // 重新启用转换按钮
            convertBtn.disabled = false;
            convertBtn.textContent = "开始转换";
          }
        });
      });

      // 重试失败文件的函数
      function retryFailedFiles(batchId) {
        const retryBtn = document.getElementById("retry-failed-btn");
        if (retryBtn) {
          retryBtn.disabled = true;
          retryBtn.textContent = "🔄 重试中...";
        }

        // 获取当前配置
        const enabledServers = apiServers.filter((server) => server.enabled);
        const concurrencyElement = document.getElementById("concurrency-slider");
        const voiceElement = document.getElementById("voice-model");
        const speedElement = document.getElementById("speed-slider");

        const concurrency = concurrencyElement ? concurrencyElement.value : "1";
        const voice = voiceElement
          ? voiceElement.value
          : "zh-CN-XiaoxiaoNeural";
        const speed = speedElement ? speedElement.value : "1.0";

        // 准备表单数据
        const formData = new FormData();
        formData.append("batch_id", batchId);
        formData.append("api_servers", JSON.stringify(enabledServers));
        formData.append("concurrency", concurrency);
        formData.append("voice", voice);
        formData.append("speed", speed);

        // 发送重试请求
        axios
          .post("/retry_failed", formData)
          .then((response) => {
            if (response.data.success) {
              // 更新批量信息显示
              document.getElementById("batch-info").innerHTML = `
                          <div class="p-3 bg-blue-50 border border-blue-200 rounded">
                              <strong>🔄 重试处理中...</strong><br>
                              正在重试 ${response.data.retry_files} 个失败文件<br>
                              处理模式: 动态负载均衡并发处理
                          </div>
                      `;

              // 隐藏文件列表，重新开始轮询
              const fileList = document.getElementById("file-list");
              if (fileList) {
                fileList.style.display = "none";
              }

              // 开始轮询进度
              startProgressPolling(batchId);
            } else {
              alert("重试失败: " + response.data.error);
              if (retryBtn) {
                retryBtn.disabled = false;
                retryBtn.textContent = "🔄 重试失败文件";
              }
            }
          })
          .catch((error) => {
            console.error("重试请求失败:", error);
            alert("重试请求失败: " + error.message);
            if (retryBtn) {
              retryBtn.disabled = false;
              retryBtn.textContent = "🔄 重试失败文件";
            }
          });
      }

      // 开始轮询进度的函数（从主转换逻辑中提取）
      function startProgressPolling(batchId) {
        const progressInterval = setInterval(async () => {
          try {
            const response = await axios.get(`/progress/${batchId}`);
            const data = response.data;

            // 更新批量信息
            document.getElementById("batch-info").innerHTML = `
                      <div class="p-3 bg-blue-50 border border-blue-200 rounded">
                          <strong>📁 批量处理信息</strong><br>
                          批次ID: ${data.batch_id}<br>
                          任务进度: ${data.completed_files}/${data.total_files} 个文件<br>
                          处理模式: 动态负载均衡并发处理
                      </div>
                  `;

            // 更新文件状态
            Object.values(data.files).forEach((file) => {
              const statusElement = document.getElementById(
                `status-${file.filename}`
              );
              const progressBar = document.querySelector(
                `#progress-${file.filename} .progress-bar`
              );
              const progressText = document.getElementById(
                `progress-text-${file.filename}`
              );

              if (statusElement && progressBar && progressText) {
                // 根据状态显示不同的图标和颜色
                let statusIcon = "⏳";
                let statusColor = "bg-gray-400";

                if (file.status === "completed") {
                  statusIcon = "✅";
                  statusColor = "bg-green-600";
                } else if (file.status === "failed") {
                  statusIcon = "❌";
                  statusColor = "bg-red-600";
                } else if (file.status === "processing") {
                  statusIcon = "🔄";
                  statusColor = "bg-blue-600";
                }

                statusElement.textContent = `${statusIcon} ${
                  file.stage || file.status
                }`;
                progressBar.style.width = `${file.progress}%`;
                progressBar.className = `progress-bar ${statusColor} h-2.5 rounded-full transition-all duration-300`;
                progressText.textContent = `${file.progress}%`;
              }
            });

            // 检查是否完成
            if (data.completed_files >= data.total_files) {
              clearInterval(progressInterval);

              // 显示文件列表
              const fileList = document.getElementById("file-list");
              if (fileList) {
                fileList.style.display = "block";
              }

              // 统计成功和失败的文件
              const files = Object.values(data.files);
              const successCount = files.filter(
                (f) => f.status === "completed"
              ).length;
              const failCount = files.filter(
                (f) => f.status === "failed"
              ).length;

              let retryButton = "";
              if (failCount > 0) {
                retryButton = `
                              <br>
                              <button id="retry-failed-btn" 
                                      class="mt-2 px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">
                                  🔄 重试失败文件 (${failCount} 个)
                              </button>
                          `;
              }

              document.getElementById("batch-info").innerHTML += `
                          <br><br>
                          <div class="p-3 bg-green-50 border border-green-200 rounded">
                              <strong>✅ 批量处理完成!</strong><br>
                              成功: ${successCount} 个文件<br>
                              失败: ${failCount} 个文件
                              ${retryButton}
                          </div>
                      `;

              // 添加重试按钮事件监听器
              if (failCount > 0) {
                document
                  .getElementById("retry-failed-btn")
                  .addEventListener("click", function () {
                    retryFailedFiles(batchId);
                  });
              }
            }
          } catch (error) {
            console.error("获取进度失败:", error);

            if (error.response && error.response.status === 404) {
              clearInterval(progressInterval);
              document.getElementById("batch-info").innerHTML += `
                          <br><br>
                          <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                              <strong>⚠️ 任务已中断</strong><br>
                              服务器重启导致任务状态丢失，请重新上传文件
                          </div>
                      `;
            }
          }
        }, 1000);
      }

      // 文件夹管理功能
      function initFolderManagement() {
        // 加载文件夹列表
        loadFolders();

        // 绑定刷新按钮事件
        document
          .getElementById("refresh-folders")
          .addEventListener("click", loadFolders);
      }

      async function loadFolders() {
        try {
          const response = await axios.get("/api/folders");
          const folders = response.data.folders;

          const foldersList = document.getElementById("folders-list");

          if (folders.length === 0) {
            foldersList.innerHTML = `
              <div class="text-center text-gray-500 py-8">
                <div class="text-4xl mb-2">📁</div>
                <p>暂无文件夹</p>
                <p class="text-sm">上传文件后会自动创建文件夹</p>
              </div>
            `;
            return;
          }

          foldersList.innerHTML = folders
            .map(
              (folder) => `
            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="flex items-center space-x-2 mb-2">
                    <span class="text-lg">📁</span>
                    <h3 class="font-semibold text-gray-800">${folder.name}</h3>
                  </div>
                  <div class="text-sm text-gray-600 space-y-1">
                    <div>📄 MD文件: ${folder.md_count} 个</div>
                    <div>🎵 MP3文件: ${folder.mp3_count} 个</div>
                    <div>📅 创建时间: ${folder.create_time}</div>
                  </div>
                </div>
                <div class="flex space-x-2 ml-4">
                  <button 
                    onclick="continueFolder('${folder.name}')"
                    class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-sm"
                    title="继续未完成"
                  >
                    ▶️ 继续
                  </button>
                  <button 
                    onclick="downloadFolder('${folder.name}')"
                    class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                    title="下载ZIP包"
                  >
                    📦 下载
                  </button>
                  <button 
                    onclick="deleteFolder('${folder.name}')"
                    class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-sm"
                    title="删除文件夹"
                  >
                    🗑️ 删除
                  </button>
                </div>
              </div>
            </div>
          `
            )
            .join("");
        } catch (error) {
          console.error("加载文件夹列表失败:", error);
          document.getElementById("folders-list").innerHTML = `
            <div class="text-center text-red-500 py-8">
              <div class="text-4xl mb-2">❌</div>
              <p>加载失败</p>
              <p class="text-sm">${
                error.response?.data?.error || error.message
              }</p>
            </div>
          `;
        }
      }

      async function downloadFolder(folderName) {
        try {
          // 显示下载提示
          const button = event.target;
          const originalText = button.textContent;
          button.textContent = "⏳ 打包中...";
          button.disabled = true;

          // 创建下载链接
          const link = document.createElement("a");
          link.href = `/api/download/${encodeURIComponent(folderName)}`;
          link.download = `${folderName}.zip`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          // 恢复按钮状态
          setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
          }, 2000);
        } catch (error) {
          console.error("下载失败:", error);
          alert(`下载失败: ${error.response?.data?.error || error.message}`);

          // 恢复按钮状态
          const button = event.target;
          button.textContent = "📦 下载";
          button.disabled = false;
        }
      }

      async function deleteFolder(folderName) {
        if (
          !confirm(
            `确定要删除文件夹 "${folderName}" 吗？\n\n此操作将永久删除文件夹及其所有内容，无法恢复！`
          )
        ) {
          return;
        }

        try {
          const response = await axios.delete(
            `/api/delete/${encodeURIComponent(folderName)}`
          );

          // 显示成功消息
          const button = event.target;
          const originalText = button.textContent;
          button.textContent = "✅ 已删除";
          button.disabled = true;

          // 刷新文件夹列表
          setTimeout(() => {
            loadFolders();
          }, 1000);
        } catch (error) {
          console.error("删除失败:", error);
          alert(`删除失败: ${error.response?.data?.error || error.message}`);
        }
      }

      async function continueFolder(folderName) {
        try {
          // 读取当前启用的服务器与参数
          const enabledServers = apiServers.filter((s) => s.enabled);
          const concurrency =
            document.getElementById("concurrency-slider")?.value || 1;
          const voice =
            document.getElementById("voice-model")?.value ||
            "zh-CN-XiaoxiaoNeural";
          const speed = document.getElementById("speed-slider")?.value || 1.0;

          const formData = new FormData();
          formData.append("api_servers", JSON.stringify(enabledServers));
          formData.append("concurrency", concurrency);
          formData.append("voice", voice);
          formData.append("speed", speed);

          const btn = event.target;
          const original = btn.textContent;
          btn.textContent = "▶️ 处理中...";
          btn.disabled = true;

          const res = await axios.post(
            `/api/continue/${encodeURIComponent(folderName)}`,
            formData
          );
          if (res.data && res.data.success && res.data.batch_id) {
            // 打开进度区域并开始轮询
            const progressSection = document.getElementById("progress-section");
            const progressContainer =
              document.getElementById("progress-container");
            progressSection.classList.remove("hidden");
            progressContainer.innerHTML = `
              <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 class="text-lg font-semibold text-blue-800 mb-2">▶️ 继续未完成</h3>
                <p class="text-sm text-blue-700">批次ID: ${res.data.batch_id}，需重试 ${res.data.retry_files} 个文件</p>
              </div>
            `;

            // 轮询进度
            let interval = setInterval(async () => {
              try {
                const p = await axios.get(`/progress/${res.data.batch_id}`);
                if (p.data) {
                  const completed = p.data.completed_files || 0;
                  const total = p.data.total_files || 0;
                  progressContainer.innerHTML = `
                    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                      <h3 class="text-lg font-semibold text-blue-800 mb-2">▶️ 继续未完成</h3>
                      <p class="text-sm text-blue-700">进度: ${completed}/${total}</p>
                    </div>
                  `;

                  // 并行获取服务器状态并渲染
                  try {
                    const s = await axios.get(
                      `/server_status/${res.data.batch_id}`
                    );
                    if (
                      s.data &&
                      s.data.server_statuses &&
                      window.updateServerMonitor
                    ) {
                      window.updateServerMonitor(s.data.server_statuses);
                    }
                  } catch (e) {
                    // 忽略状态获取失败
                  }
                  if (completed >= total) {
                    clearInterval(interval);
                    btn.textContent = "▶️ 继续";
                    btn.disabled = false;
                  }
                }
              } catch (e) {}
            }, 1000);
          } else {
            alert(res.data?.error || "继续处理启动失败");
            btn.textContent = original;
            btn.disabled = false;
          }
        } catch (error) {
          alert(
            `继续处理失败: ${error.response?.data?.error || error.message}`
          );
          const btn = event.target;
          btn.textContent = "▶️ 继续";
          btn.disabled = false;
        }
      }
    </script>
  </body>
</html>
